<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cart Summary</title>

  <style>
    :root {
      --bg:#0f172a;
      --card-bg:rgba(30,41,59,.8);
      --border:rgba(148,163,184,.2);
      --text:#e2e8f0;
      --text-muted:#94a3b8;
      --accent-green:#10b981;
      --danger:#ef4444;
      --radius:14px;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui;background:var(--bg);color:var(--text)}
    header{background:linear-gradient(135deg,#1e293b,#0f172a);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center}
    header h2{background:linear-gradient(90deg,#93c5fd,#c7d2fe);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .header-btn{background:#ef4444;color:white;border:none;padding:.6rem 1.2rem;border-radius:10px;font-weight:600;cursor:pointer}
    .container{max-width:720px;margin:auto;padding:1.8rem}
    .item{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);padding:1.3rem;margin-bottom:1rem}
    .item b{font-size:1.2rem}
    .item div{color:var(--text-muted);margin-top:.4rem}
    .total{text-align:right;font-size:1.6rem;font-weight:700;color:var(--accent-green);margin:1.5rem 0}
    input{width:100%;padding:1rem;margin-bottom:1rem;border-radius:12px;border:1px solid var(--border);background:#33415599;color:var(--text)}
    .btn{width:100%;padding:1.1rem;border:none;border-radius:12px;font-size:1.1rem;font-weight:600;cursor:pointer;margin-top:.8rem}
    .confirm{background:linear-gradient(135deg,#10b981,#059669);color:white}
    .cancel{background:#475569;color:white}
  </style>
</head>

<body>

<header>
  <button class="header-btn" onclick="location.href='sell.html'">‚Üê Back</button>
  <h2>Cart Summary</h2>
  <span></span>
</header>

<div class="container">
  <div id="cartItems"></div>
  <div class="total">Total: ‚Çπ<span id="total">0</span></div>

  <input id="custName" placeholder="Customer Name" />
  <input id="custPhone" placeholder="Customer Phone" />

  <button class="btn confirm" onclick="confirmSell()">CONFIRM SELL</button>
  <button class="btn cancel" onclick="cancelCart()">CANCEL</button>
</div>

<script type="module">
import { requireAuth } from "../auth/guard.js";
import { db } from "../js/firebase.js";
import {
  collection,
  addDoc,
  doc,
  updateDoc,
  increment,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üîí SHOPKEEPER + WORKER */
const user = requireAuth(["SHOPKEEPER","WORKER"]);

/* CART */
const cart = JSON.parse(localStorage.getItem("cart"));
if (!cart || !cart.items.length) {
  alert("Cart is empty");
  location.href = "sell.html";
}

const list = document.getElementById("cartItems");
let total = 0;

cart.items.forEach(i=>{
  total += i.sellPrice * i.quantity;
  list.innerHTML += `
    <div class="item">
      <b>${i.name}</b>
      <div>Qty: ${i.quantity} √ó ‚Çπ${i.sellPrice}</div>
      <div>Subtotal: ‚Çπ${(i.sellPrice*i.quantity).toLocaleString()}</div>
    </div>
  `;
});

document.getElementById("total").innerText = total.toLocaleString();

/* CONFIRM SELL */
window.confirmSell = async () => {

  if (!custName.value || !custPhone.value)
    return alert("Enter customer details");

  /* 1Ô∏è‚É£ CREATE SALE */
  const saleRef = await addDoc(collection(db,"sales"),{
    shopId: user.shopId,
    amount: total,
    soldBy: user.uid,
    customerName: custName.value,
    customerPhone: custPhone.value,
    createdAt: serverTimestamp()
  });

  /* 2Ô∏è‚É£ UPDATE STOCK */
  for (const i of cart.items) {
    await updateDoc(doc(db,"stock",i.productId),{
      quantity: increment(-i.quantity)
    });
  }

  /* 3Ô∏è‚É£ CREATE JOB (SELL) */
  await addDoc(collection(db,"jobs"),{
    shopId: user.shopId,
    type: "SELL",
    status: "DELIVERED",
    saleId: saleRef.id,
    customerName: custName.value,
    customerPhone: custPhone.value,
    totalAmount: total,
    createdAt: serverTimestamp()
  });

  /* 4Ô∏è‚É£ AUDIT LOG */
  await addDoc(collection(db,"auditLogs"),{
    userId: user.uid,
    role: user.role,
    actionType: "SALE",
    action: `Sold items worth ‚Çπ${total}`,
    shopId: user.shopId,
    timestamp: serverTimestamp()
  });

  /* 5Ô∏è‚É£ MESSAGE HOOK (NO API) */
  /*
    NEXT STEP:
    const msg = `Thank you ${custName.value}, your purchase of ‚Çπ${total} is confirmed.`;
    window.open(`https://wa.me/${custPhone.value}?text=${encodeURIComponent(msg)}`);
  */

  localStorage.removeItem("cart");
  alert("Sale completed");
  location.href = "sell.html";
};

/* CANCEL */
window.cancelCart = () => {
  localStorage.removeItem("cart");
  location.href = "sell.html";
};
</script>

</body>
</html>
