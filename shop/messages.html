<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Send WhatsApp Updates</title>

<style>
:root{
  --bg:#0f172a;
  --card-bg:rgba(30,41,59,.85);
  --border:rgba(148,163,184,.22);
  --text:#e2e8f0;
  --text-muted:#94a3b8;
  --green:#10b981;
  --blue:#3b82f6;
  --radius:16px;
  --shadow:0 8px 24px rgba(0,0,0,.35);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui;background:var(--bg);color:var(--text);min-height:100vh}

header{
  background:linear-gradient(135deg,#1e293b,#0f172a);
  border-bottom:1px solid var(--border);
  padding:1rem 1.5rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header button{
  background:#ef4444;
  color:white;
  border:none;
  padding:.6rem 1.3rem;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}
header h2{
  background:linear-gradient(90deg,#93c5fd,#c7d2fe);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

.container{
  max-width:900px;
  margin:auto;
  padding:1.8rem 1.5rem;
}

.filters{
  display:flex;
  flex-wrap:wrap;
  gap:.8rem;
  margin-bottom:1.5rem;
}

.filter-btn{
  padding:.6rem 1.2rem;
  border-radius:20px;
  border:1px solid var(--border);
  background:var(--card-bg);
  color:var(--text);
  cursor:pointer;
  font-weight:600;
}
.filter-btn.active{
  background:var(--blue);
}

.card{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1.5rem;
  margin-bottom:1.2rem;
  box-shadow:var(--shadow);
}
.card b{
  font-size:1.2rem;
  display:block;
  margin-bottom:.6rem;
}
.card div{
  color:var(--text-muted);
  margin:.4rem 0;
}

.send-btn{
  margin-top:1rem;
  width:100%;
  padding:1rem;
  background:linear-gradient(135deg,#10b981,#059669);
  border:none;
  border-radius:12px;
  font-weight:600;
  color:white;
  cursor:pointer;
}

.marked{
  margin-top:.8rem;
  padding:.6rem;
  background:rgba(16,185,129,.15);
  border-radius:10px;
  font-size:.85rem;
  color:var(--green);
}

.empty{
  text-align:center;
  padding:4rem;
  color:var(--text-muted);
}
</style>
</head>

<body>

<header>
<button onclick="location.href='index.html'">‚Üê Back</button>
<h2>Send WhatsApp Updates</h2>
<span></span>
</header>

<div class="container">

<div class="filters">
  <div class="filter-btn active" onclick="setFilter(null,this)">ALL</div>
  <div class="filter-btn" onclick="setFilter('OPEN',this)">OPEN</div>
  <div class="filter-btn" onclick="setFilter('IN_PROGRESS',this)">IN PROGRESS</div>
  <div class="filter-btn" onclick="setFilter('DONE_NOT_DELIVERED',this)">READY</div>
  <div class="filter-btn" onclick="setFilter('DONE_DELIVERED',this)">DELIVERED</div>
</div>

<div id="list"></div>

</div>

<script type="module">

import { db } from "../js/firebase.js";
import {
  collection,
  query,
  where,
  getDocs,
  doc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const currentUser = JSON.parse(localStorage.getItem("currentUser"));
if(!currentUser || currentUser.role !== "SHOPKEEPER"){
  location.href="/login.html";
}

const list = document.getElementById("list");
let activeFilter = null;

window.setFilter = (status,el)=>{
  activeFilter = status;
  document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
  el.classList.add("active");
  loadJobs();
};

async function loadJobs(){

  let q = query(
    collection(db,"jobs"),
    where("shopId","==",currentUser.shopId),
    where("type","==","REPAIR")
  );

  const snap = await getDocs(q);

  if(snap.empty){
    list.innerHTML = `<div class="empty">No jobs available</div>`;
    return;
  }

  list.innerHTML="";

  snap.forEach(docSnap=>{

    const job = docSnap.data();
    const jobId = docSnap.id;

    if(activeFilter && job.status !== activeFilter) return;

    const message = buildMessage(job);
    const encoded = encodeURIComponent(message);
    const phone = "91" + job.customerPhone.replace(/\D/g,'');
    const waURL = `https://wa.me/${phone}?text=${encoded}`;

    list.innerHTML += `
      <div class="card">
        <b>${job.device}</b>
        <div><strong>Customer:</strong> ${job.customerName}</div>
        <div><strong>Status:</strong> ${job.status.replaceAll("_"," ")}</div>
        <div><strong>Expected Cost:</strong> ‚Çπ${job.expectedCost || 0}</div>

        <button class="send-btn"
          onclick="sendMessage('${jobId}','${waURL}')">
          Send WhatsApp Update
        </button>

        ${
          job.lastMessageSentAt
          ? `<div class="marked">
              Message sent at:
              ${new Date(job.lastMessageSentAt.seconds*1000).toLocaleString()}
            </div>`
          : ""
        }
      </div>
    `;
  });
}

/* üî• Manual Send + Track */
window.sendMessage = async(jobId,url)=>{

  window.open(url,"_blank");

  await updateDoc(doc(db,"jobs",jobId),{
    lastMessageSentAt:serverTimestamp(),
    lastMessageSentBy:currentUser.uid
  });

  loadJobs();
};

/* üì© Message Builder */
function buildMessage(job){

  const status = job.status.replaceAll("_"," ");

  return `Hello ${job.customerName},

Your device: ${job.device}

Current Status: ${status}

Expected Cost: ‚Çπ${job.expectedCost || 0}

Thank you for choosing our service.`;
}

loadJobs();

</script>

</body>
</html>
