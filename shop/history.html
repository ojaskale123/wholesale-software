<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Shopkeeper ¬∑ History</title>

<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --border:#334155;
  --text:#e2e8f0;
  --muted:#94a3b8;
  --green:#10b981;
  --blue:#3b82f6;
  --radius:16px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui;background:var(--bg);color:var(--text)}

header{
  padding:1.2rem 1.5rem;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header h3{
  background:linear-gradient(90deg,#93c5fd,#c7d2fe);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

button{
  background:#ef4444;
  border:none;
  padding:.6rem 1.2rem;
  border-radius:10px;
  color:white;
  cursor:pointer;
}

.container{
  max-width:1100px;
  margin:auto;
  padding:2rem 1.5rem;
}

.tabs{
  display:flex;
  gap:1rem;
  margin-bottom:1.5rem;
}

.tab{
  padding:.6rem 1.2rem;
  border-radius:10px;
  background:#334155;
  cursor:pointer;
}

.tab.active{
  background:var(--blue);
}

.list{
  display:grid;
  gap:1rem;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1.2rem;
}

.card b{font-size:1.1rem}
.meta{color:var(--muted);margin-top:.4rem}
.amount{color:var(--green);font-weight:700;margin-top:.6rem}
.empty{
  text-align:center;
  color:var(--muted);
  padding:3rem 1rem;
}
</style>
</head>

<body>

<header>
  <h3>Shop History</h3>
  <button onclick="location.href='index.html'">‚Üê Back</button>
</header>

<div class="container">

  <div class="tabs">
    <div class="tab active" onclick="switchTab('SALES')" id="salesTab">Sales</div>
    <div class="tab" onclick="switchTab('REPAIRS')" id="repairTab">Repairs</div>
  </div>

  <div id="historyList" class="list"></div>

</div>

<script type="module">
import { requireAuth } from "../auth/guard.js";
import { db } from "../js/firebase.js";
import {
  collection,
  query,
  where,
  getDocs,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üîê SHOPKEEPER ONLY */
const user = requireAuth("SHOPKEEPER");
const shopId = user.shopId;

const historyList = document.getElementById("historyList");

let CURRENT_TAB = "SALES";

/* SWITCH TAB */
window.switchTab = function(type){
  CURRENT_TAB = type;

  document.getElementById("salesTab").classList.remove("active");
  document.getElementById("repairTab").classList.remove("active");

  if(type==="SALES"){
    document.getElementById("salesTab").classList.add("active");
  }else{
    document.getElementById("repairTab").classList.add("active");
  }

  loadHistory();
};

/* LOAD HISTORY */
async function loadHistory(){
  historyList.innerHTML = "Loading...";

  if(CURRENT_TAB === "SALES"){
    const q = query(
      collection(db,"sales"),
      where("shopId","==",shopId),
      orderBy("createdAt","desc")
    );

    const snap = await getDocs(q);
    renderSales(snap);

  } else {

    const q = query(
      collection(db,"jobs"),
      where("shopId","==",shopId),
      where("type","==","REPAIR"),
      orderBy("createdAt","desc")
    );

    const snap = await getDocs(q);
    renderRepairs(snap);
  }
}

/* RENDER SALES */
function renderSales(snap){
  historyList.innerHTML="";

  if(snap.empty){
    historyList.innerHTML="<div class='empty'>No sales yet</div>";
    return;
  }

  snap.forEach(docSnap=>{
    const s = docSnap.data();

    const div = document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <b>Customer: ${s.customerName || "Walk-in"}</b>
      <div class="meta">Phone: ${s.customerPhone || "-"}</div>
      <div class="meta">
        ${s.createdAt?.toDate().toLocaleString() || "-"}
      </div>
      <div class="amount">‚Çπ${(s.amount||0).toLocaleString()}</div>
    `;
    historyList.appendChild(div);
  });
}

/* RENDER REPAIRS */
function renderRepairs(snap){
  historyList.innerHTML="";

  if(snap.empty){
    historyList.innerHTML="<div class='empty'>No repair jobs yet</div>";
    return;
  }

  snap.forEach(docSnap=>{
    const j = docSnap.data();

    const div = document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <b>${j.customerName || "Customer"}</b>
      <div class="meta">Phone: ${j.customerPhone || "-"}</div>
      <div class="meta">Status: ${j.status || "-"}</div>
      <div class="meta">
        ${j.createdAt?.toDate().toLocaleString() || "-"}
      </div>
    `;
    historyList.appendChild(div);
  });
}

/* INIT */
loadHistory();

</script>

</body>
</html>
