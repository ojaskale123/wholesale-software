<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stock</title>

<style>
body {
  margin:0;
  font-family:Segoe UI, Arial, sans-serif;
  background:#f4f6f8;
}

.header {
  padding:20px;
  background:#203a43;
  color:white;
  font-size:22px;
  font-weight:600;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.add-btn {
  background:#2ecc71;
  padding:10px 16px;
  border-radius:12px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
}

.stock-grid {
  padding:20px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:18px;
}

.stock-card {
  background:white;
  border-radius:16px;
  padding:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.12);
  cursor:pointer;
}

.stock-name {
  font-weight:600;
  margin-bottom:6px;
}

.stock-meta {
  font-size:13px;
  color:#666;
  margin-bottom:4px;
}

.price {
  margin-top:8px;
  font-weight:700;
  color:#2ecc71;
}

/* MODAL */
.overlay {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
}

.modal {
  display:none;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:white;
  padding:20px;
  border-radius:16px;
  width:90%;
  max-width:400px;
}

.modal input {
  width:100%;
  padding:10px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid #ccc;
}

.modal button {
  width:100%;
  padding:12px;
  background:#203a43;
  color:white;
  border:none;
  border-radius:10px;
  font-weight:600;
}
</style>
</head>

<body>

<div class="header">
  <div>Stock</div>
  <div class="add-btn" id="addBtn">+ Add Stock</div>
</div>

<div class="stock-grid" id="stockGrid"></div>

<!-- MODAL -->
<div class="overlay" id="overlay"></div>
<div class="modal" id="modal">
  <input id="name" placeholder="Item name">
  <input id="category" placeholder="Category">
  <input id="quantity" type="number" placeholder="Quantity">
  <input id="sellPrice" type="number" placeholder="Sell price">
  <button id="saveBtn">Save</button>
</div>

<script type="module">
import { db } from "../js/firebase.js";
import {
  collection,
  addDoc,
  getDocs,
  query,
  where,
  serverTimestamp,
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ” AUTH */
const currentUser = JSON.parse(localStorage.getItem("currentUser"));
if (!currentUser || currentUser.role !== "SHOPKEEPER") {
  alert("Access denied");
  location.href = "/login.html";
}
const shopId = currentUser.shopId;

/* UI */
const stockGrid = document.getElementById("stockGrid");
const modal = document.getElementById("modal");
const overlay = document.getElementById("overlay");

let editId = null;

/* LOAD STOCK */
async function loadStock() {
  stockGrid.innerHTML = "";
  const q = query(collection(db, "stock"), where("shopId", "==", shopId));
  const snap = await getDocs(q);

  snap.forEach(d => {
    const item = d.data();
    const card = document.createElement("div");
    card.className = "stock-card";
    card.innerHTML = `
      <div class="stock-name">${item.name}</div>
      <div class="stock-meta">Category: ${item.category}</div>
      <div class="stock-meta">Qty: ${item.quantity}</div>
      <div class="price">â‚¹${item.sellPrice}</div>
    `;

    card.onclick = () => openEdit(d.id, item);
    stockGrid.appendChild(card);
  });
}

/* OPEN EDIT */
function openEdit(id, item) {
  editId = id;
  name.value = item.name;
  category.value = item.category;
  quantity.value = item.quantity;
  sellPrice.value = item.sellPrice;
  modal.style.display = "block";
  overlay.style.display = "block";
}

/* SAVE */
saveBtn.onclick = async () => {
  const data = {
    name: name.value.trim(),
    category: category.value.trim(),
    quantity: Number(quantity.value),
    sellPrice: Number(sellPrice.value)
  };

  if (!data.name || !data.category) {
    alert("Invalid data");
    return;
  }

  if (editId) {
    await updateDoc(doc(db, "stock", editId), data);
  } else {
    await addDoc(collection(db, "stock"), {
      ...data,
      shopId,
      createdAt: serverTimestamp()
    });
  }

  editId = null;
  modal.style.display = "none";
  overlay.style.display = "none";
  loadStock();
};

/* ADD NEW */
addBtn.onclick = () => {
  editId = null;
  name.value = "";
  category.value = "";
  quantity.value = "";
  sellPrice.value = "";
  modal.style.display = "block";
  overlay.style.display = "block";
};

overlay.onclick = () => {
  modal.style.display = "none";
  overlay.style.display = "none";
};

loadStock();
</script>

</body>
</html>
