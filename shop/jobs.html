<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Shop ‚Äì Repair Jobs</title>

<style>
:root{
  --bg:#0f172a;
  --card-bg:rgba(30,41,59,.82);
  --border:rgba(148,163,184,.22);
  --text:#e2e8f0;
  --text-muted:#94a3b8;
  --accent:#3b82f6;
  --success:#10b981;
  --danger:#ef4444;
  --radius:16px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui;background:var(--bg);color:var(--text)}
header{
  background:linear-gradient(135deg,#1e293b,#0f172a);
  padding:1rem 1.5rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid var(--border);
}
header h2{
  background:linear-gradient(90deg,#93c5fd,#c7d2fe);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
header button{
  background:#ef4444;
  border:none;
  color:white;
  padding:.6rem 1.2rem;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}
.container{
  max-width:1000px;
  margin:auto;
  padding:1.8rem 1.5rem;
}
.job{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1.4rem;
  margin-bottom:1.2rem;
}
.job b{font-size:1.2rem}
.job div{margin:.4rem 0;color:var(--text-muted)}
.status{
  display:inline-block;
  padding:.35rem .9rem;
  border-radius:999px;
  font-size:.75rem;
  font-weight:700;
  color:white;
  margin-top:.6rem;
}
.OPEN{background:#d97706}
.IN_PROGRESS{background:var(--accent)}
.DONE_NOT_DELIVERED{background:#8b5cf6}
.DONE_DELIVERED{background:var(--success)}

.btn{
  width:100%;
  margin-top:.9rem;
  padding:.9rem;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  color:white;
}
.btn-whatsapp{background:linear-gradient(135deg,#10b981,#059669)}
.btn-disabled{background:#475569;cursor:not-allowed}

.empty{
  text-align:center;
  padding:4rem;
  color:var(--text-muted);
}
</style>
</head>

<body>

<header>
  <button onclick="location.href='index.html'">‚Üê Back</button>
  <h2>Repair Jobs</h2>
  <span></span>
</header>

<div class="container">
  <div id="list"></div>
</div>

<script type="module">
import { requireAuth } from "../auth/guard.js";
import { db } from "../js/firebase.js";
import {
  collection,
  query,
  where,
  getDocs,
  doc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üîê SHOPKEEPER ONLY */
const user = requireAuth(["SHOPKEEPER"]);
const list = document.getElementById("list");

/* LOAD JOBS */
async function loadJobs(){

  const q = query(
    collection(db,"jobs"),
    where("shopId","==",user.shopId),
    where("type","==","REPAIR")
  );

  const snap = await getDocs(q);

  if(snap.empty){
    list.innerHTML=`<div class="empty">No repair jobs found</div>`;
    return;
  }

  list.innerHTML="";

  snap.forEach(docSnap=>{
    const j = docSnap.data();
    const jobId = docSnap.id;

    list.innerHTML += `
      <div class="job">
        <b>${j.device}</b>
        <div>Customer: <strong>${j.customerName}</strong></div>
        <div>Phone: ${j.customerPhone}</div>
        <div>Expected Cost: ‚Çπ${j.expectedCost || 0}</div>
        <div>Assigned To: ${j.assignedTo || "Not assigned"}</div>

        <span class="status ${j.status}">
          ${j.status.replaceAll("_"," ")}
        </span>

        ${
          j.lastMessageSentAt
          ? `<div style="margin-top:.6rem;color:#10b981">
              WhatsApp Sent
            </div>`
          : ""
        }

        ${
          j.status==="DONE_NOT_DELIVERED"
          ? `<button class="btn btn-whatsapp"
               onclick="sendWhatsApp('${jobId}','${j.customerPhone}','${j.customerName}','${j.device}','${j.expectedCost}')">
               SEND WHATSAPP
             </button>`
          : ""
        }
      </div>
    `;
  });
}

/* üì≤ MANUAL WHATSAPP SYSTEM */
window.sendWhatsApp = async(jobId, phone, name, device, cost)=>{

  const message =
`Hello ${name},

Your device (${device}) is ready.

Total Cost: ‚Çπ${cost}

You can collect it from the shop.

Thank you.`;

  const url = `https://wa.me/91${phone}?text=${encodeURIComponent(message)}`;

  window.open(url,"_blank");

  /* STORE MESSAGE INFO */
  await updateDoc(doc(db,"jobs",jobId),{
    lastMessageSentAt: serverTimestamp(),
    lastMessageSentBy: user.uid
  });

  alert("WhatsApp opened successfully.");
  loadJobs();
};

loadJobs();
</script>

</body>
</html>
