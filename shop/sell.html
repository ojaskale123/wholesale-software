<script type="module">
import { DB, saveDB } from "../db/fakeDB.js";

const user = JSON.parse(localStorage.getItem("currentUser"));
if (!user || !["SHOPKEEPER","WORKER"].includes(user.role)) {
  location.href = "/login.html";
}

DB.products = DB.products || [];

let cart = { items: [] };
let activeCategory = null;

const list = document.getElementById("list");
const search = document.getElementById("search");

window.setCategory = cat => {
  activeCategory = cat;
  render();
};

function render() {
  const q = search.value.toLowerCase();
  list.innerHTML = "";

  DB.products
    .filter(p => String(p.shopId) === String(user.shopId))
    .filter(p => !activeCategory || p.category === activeCategory)
    .filter(p =>
      p.name.toLowerCase().includes(q) ||
      String(p.barcode || "").includes(q)
    )
    .forEach(p => {
      const inCart = cart.items.find(i => i.productId === p.id);
      const qty = inCart ? inCart.quantity : 0;

      list.innerHTML += `
        <div class="item">
          <div>
            <b>${p.name}</b><br>
            ₹${p.sellPrice} | Stock: ${p.quantity}
          </div>
          <div class="qty">
            <button onclick="updateQty('${p.id}',-1)">−</button>
            ${qty}
            <button onclick="updateQty('${p.id}',1)">+</button>
          </div>
        </div>
      `;
    });

  updateCartBar();
}

window.updateQty = (id, delta) => {
  const product = DB.products.find(p => p.id === id);
  let item = cart.items.find(i => i.productId === id);

  if (!item && delta > 0) {
    if (product.quantity <= 0) return alert("Out of stock");
    cart.items.push({
      productId: id,
      name: product.name,
      sellPrice: product.sellPrice,
      quantity: 1
    });
  } else if (item) {
    item.quantity += delta;
    if (item.quantity <= 0)
      cart.items = cart.items.filter(i => i.productId !== id);
  }
  render();
};

function updateCartBar() {
  const count = cart.items.reduce((s,i)=>s+i.quantity,0);
  const total = cart.items.reduce((s,i)=>s+i.sellPrice*i.quantity,0);
  itemCount.innerText = count;
  totalAmount.innerText = total;
  cartBar.style.display = count ? "flex" : "none";
}

search.oninput = render;
render();
</script>
