<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Owner Dashboard</title>
  <link rel="stylesheet" href="../css/style.css">

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(180deg,#0f2027,#203a43,#2c5364);
    }

    .hero {
      position: relative;
      padding: 28px 24px 36px;
      color: white;
    }

    .hero h1 {
      margin: 0;
      font-size: 30px;
    }

    .hero p {
      margin-top: 6px;
      font-size: 14px;
      color: #d0d8dc;
    }

    .create-shop-card {
      margin-top: 22px;
      max-width: 260px;
      background: linear-gradient(135deg,#2ecc71,#27ae60);
      padding: 16px 18px;
      border-radius: 18px;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 10px 28px rgba(0,0,0,0.35);
      transition: transform 0.2s ease;
    }

    .create-shop-card:hover {
      transform: translateY(-4px);
    }

    .create-shop-card span {
      font-size: 13px;
      font-weight: normal;
      display: block;
      margin-top: 4px;
      color: #083d1f;
    }

    .dashboard {
      background: #f4f6f8;
      border-radius: 28px 28px 0 0;
      padding: 26px;
      min-height: 100vh;
    }

    .shop-strip {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      margin-bottom: 30px;
    }

    .shop-card {
      min-width: 240px;
      background: white;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.15);
      position: relative;
    }

    .shop-card h4 {
      margin: 0;
      font-size: 17px;
      color: #203a43;
    }

    .shop-card p {
      margin-top: 6px;
      font-size: 13px;
      color: #666;
    }

    .menu {
      position: absolute;
      top: 12px;
      right: 14px;
      font-size: 18px;
      cursor: pointer;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
      gap: 18px;
      margin-bottom: 40px;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 18px;
      box-shadow: 0 8px 22px rgba(0,0,0,0.15);
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .card:hover {
      transform: translateY(-4px);
    }

    .card h2 {
      margin: 0;
      font-size: 30px;
      color: #203a43;
    }

    .card p {
      margin-top: 6px;
      font-size: 14px;
      color: #666;
    }

    table {
      width: 100%;
      background: white;
      border-radius: 16px;
      border-collapse: collapse;
      overflow: hidden;
    }

    th {
      background: #203a43;
      color: white;
      padding: 12px;
      font-size: 14px;
    }

    td {
      padding: 10px 12px;
      font-size: 13px;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>

<body>

<div class="hero">
  <h1>Welcome, Owner</h1>
  <p>Monitor all shops, sales, staff, and activity from one place</p>

  <!-- UPDATED LINK -->
  <div class="create-shop-card" onclick="location.href='create.html'">
    âž• Create
    <span>Create shopkeeper or worker</span>
  </div>
</div>

<div class="dashboard">

  <h3>Shops</h3>
  <div class="shop-strip" id="shopStrip"></div>

  <div class="card-grid">
    <div class="card">
      <h2 id="shopCount">0</h2>
      <p>Total Shops</p>
    </div>

    <div class="card" onclick="location.href='stock.html'">
      <h2>ðŸ“¦</h2>
      <p>Stock Overview</p>
    </div>

    <div class="card">
      <h2 id="shopkeeperCount">0</h2>
      <p>Shopkeepers</p>
    </div>

    <div class="card">
      <h2 id="workerCount">0</h2>
      <p>Workers</p>
    </div>

    <div class="card">
      <h2 id="jobCount">0</h2>
      <p>Total Jobs</p>
    </div>

    <div class="card">
      <h2 id="customerCount">0</h2>
      <p>Customers</p>
    </div>
  </div>

  <h3>Activity</h3>
  <table>
    <thead>
      <tr>
        <th>User</th>
        <th>Role</th>
        <th>Action</th>
        <th>Time</th>
      </tr>
    </thead>
    <tbody id="auditTable"></tbody>
  </table>

</div>

<script type="module">
  import { requireAuth } from "../auth/guard.js";
  import { DB } from "../db/fakeDB.js";

  requireAuth(["OWNER"]);

  shopCount.innerText = DB.shops.length;
  shopkeeperCount.innerText = DB.users.filter(u => u.role === "SHOPKEEPER").length;
  workerCount.innerText = DB.users.filter(u => u.role === "WORKER").length;
  jobCount.innerText = DB.sales.length;

  const uniqueCustomers = new Set(DB.sales.map(s => s.customerPhone));
  customerCount.innerText = uniqueCustomers.size;

  const strip = document.getElementById("shopStrip");

  DB.shops.forEach(shop => {
    const shopkeeper = DB.users.find(u => u.id === shop.shopkeeperId);
    const workers = DB.users.filter(
      u => u.role === "WORKER" && u.shopId === shop.id
    );

    const d = document.createElement("div");
    d.className = "shop-card";
    d.innerHTML = `
      <span class="menu">â‹®</span>
      <h4>${shop.name}</h4>
      <p>Shopkeeper: ${shopkeeper?.name || "-"}</p>
      <p>Workers: ${workers.length}</p>
    `;
    strip.appendChild(d);
  });

  DB.auditLogs.slice().reverse().forEach(log => {
    const u = DB.users.find(x => x.id === log.userId);
    auditTable.innerHTML += `
      <tr>
        <td>${u?.name || "Unknown"}</td>
        <td>${log.role}</td>
        <td>${log.action}</td>
        <td>${new Date(log.timestamp).toLocaleString()}</td>
      </tr>
    `;
  });
</script>

</body>
</html>
