<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Owner Dashboard</title>

<style>
:root { --primary:#203a43; --bg:#f4f6f8; }
body {
  margin:0;
  font-family:Segoe UI, Arial, sans-serif;
  background:linear-gradient(180deg,#0f2027,#203a43,#2c5364);
}
.hero {
  padding:32px 26px 42px;
  color:white;
}
.hero h1 { margin:0;font-size:32px; }
.hero p { margin-top:6px;font-size:14px;color:#cfd8dc; }
.create-btn {
  margin-top:22px;
  background:linear-gradient(135deg,#2ecc71,#27ae60);
  padding:14px 20px;
  border-radius:20px;
  cursor:pointer;
  display:inline-block;
  font-weight:600;
}
.logout-btn {
  margin-left:12px;
  background:#e74c3c;
  padding:14px 20px;
  border-radius:20px;
  cursor:pointer;
  display:inline-block;
  font-weight:600;
}
.dashboard {
  background:var(--bg);
  border-radius:30px 30px 0 0;
  padding:30px;
  min-height:100vh;
}

/* SHOPS */
.shop-strip {
  display:flex;
  gap:18px;
  overflow-x:auto;
  margin-bottom:36px;
}
.shop-card {
  min-width:260px;
  background:white;
  border-radius:20px;
  padding:18px;
  box-shadow:0 10px 28px rgba(0,0,0,.15);
  cursor:pointer;
  transition:.2s;
}
.shop-card:hover { transform:translateY(-4px); }

/* CARDS */
.card-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-bottom:45px;
}
.card {
  background:white;
  border-radius:20px;
  padding:22px;
  box-shadow:0 10px 26px rgba(0,0,0,.15);
  cursor:pointer;
}
.count { font-size:30px;font-weight:700;color:var(--primary); }
.label { font-size:14px;color:#666; }

/* TABLE */
table {
  width:100%;
  background:white;
  border-radius:18px;
  border-collapse:collapse;
}
th {
  background:var(--primary);
  color:white;
  padding:14px;
}
td {
  padding:12px;
  font-size:13px;
  border-bottom:1px solid #eee;
}
</style>
</head>

<body>

<!-- ðŸ”’ OWNER ROUTE PROTECTION -->
<script type="module">
  import { requireAuth } from "../auth/guard.js";
  requireAuth("OWNER");
</script>

<div class="hero">
  <h1>Owner Dashboard</h1>
  <p>All shops, staff, sales & activity</p>

  <div class="create-btn" onclick="location.href='create.html'">âž• Create</div>
  <div class="logout-btn" id="logoutBtn">Logout</div>
</div>

<div class="dashboard">

<h3>Shops</h3>
<div class="shop-strip" id="shopStrip"></div>

<div class="card-grid">

  <div class="card">
    <div class="count" id="totalRevenue">â‚¹0</div>
    <div class="label">Total Revenue</div>
  </div>

  <div class="card">
    <div class="count" id="shopkeeperCount">0</div>
    <div class="label">Shopkeepers</div>
  </div>

  <div class="card">
    <div class="count" id="workerCount">0</div>
    <div class="label">Workers</div>
  </div>

  <div class="card">
    <div class="count" id="jobCount">0</div>
    <div class="label">Jobs</div>
  </div>

</div>

<h3>Recent Activity</h3>
<table>
<thead>
<tr>
  <th>User</th>
  <th>Role</th>
  <th>Activity</th>
  <th>Time</th>
</tr>
</thead>
<tbody id="auditTable"></tbody>
</table>

</div>

<script type="module">
import { db } from "../js/firebase.js";
import {
  collection,
  getDocs,
  query,
  where,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ”¹ LOAD SHOPS */
async function loadShops() {
  const snap = await getDocs(collection(db, "shops"));
  shopStrip.innerHTML = "";
  snap.forEach(docSnap => {
    const shop = docSnap.data();
    const card = document.createElement("div");
    card.className = "shop-card";
    card.innerHTML = `<h4>${shop.name}</h4>`;
    shopStrip.appendChild(card);
  });
}

/* ðŸ”¹ LOAD USER COUNTS */
async function loadCounts() {
  const shopkeepersQ = query(
    collection(db, "users"),
    where("role", "==", "SHOPKEEPER")
  );
  const workersQ = query(
    collection(db, "users"),
    where("role", "==", "WORKER")
  );

  const [sSnap, wSnap] = await Promise.all([
    getDocs(shopkeepersQ),
    getDocs(workersQ)
  ]);

  shopkeeperCount.innerText = sSnap.size;
  workerCount.innerText = wSnap.size;
}

/* ðŸ”¹ LOAD JOB COUNT */
async function loadJobCount() {
  const snap = await getDocs(collection(db, "jobs"));
  jobCount.innerText = snap.size;
}

/* ðŸ”¹ LOAD REVENUE (SALES + JOBS) */
async function loadRevenue() {
  let total = 0;

  // SALES revenue
  const salesSnap = await getDocs(collection(db, "sales"));
  salesSnap.forEach(d => {
    const s = d.data();
    total += Number(s.amount || s.total || 0);
  });

  // JOBS revenue (delivered only)
  const jobsSnap = await getDocs(collection(db, "jobs"));
  jobsSnap.forEach(d => {
    const j = d.data();
    if (j.status === "DELIVERED" || j.status === "DONE_DELIVERED") {
      total += Number(j.expectedCost || j.amount || 0);
    }
  });

  totalRevenue.innerText = "â‚¹" + total;
}

/* ðŸ”¹ LOAD ACTIVITY */
async function loadAuditLogs() {
  const q = query(
    collection(db, "auditLogs"),
    orderBy("timestamp", "desc")
  );

  const snap = await getDocs(q);
  auditTable.innerHTML = "";

  snap.forEach(d => {
    const log = d.data();
    auditTable.innerHTML += `
      <tr>
        <td>${log.userId || "-"}</td>
        <td>${log.role || "-"}</td>
        <td>${log.message || log.action}</td>
        <td>${log.timestamp?.toDate().toLocaleString() || "-"}</td>
      </tr>
    `;
  });
}

/* ðŸ”¹ INIT */
loadShops();
loadCounts();
loadJobCount();
loadRevenue();
loadAuditLogs();
</script>

<!-- ðŸ”“ LOGOUT -->
<script type="module">
import { auth } from "../js/firebase.js";
import { signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

document.getElementById("logoutBtn").onclick = async () => {
  await signOut(auth);
  localStorage.removeItem("currentUser");
  location.href = "/login.html";
};
</script>

</body>
</html>
