<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Owner Dashboard</title>

<style>
:root {
  --bg:#0f172a;
  --card:rgba(30,41,59,.75);
  --border:rgba(148,163,184,.18);
  --text:#f1f5f9;
  --radius:16px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
}

header{
  padding:2rem;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

button{
  padding:.6rem 1rem;
  border:none;
  border-radius:10px;
  cursor:pointer;
  background:#1d4ed8;
  color:white;
  margin-left:.5rem;
}

main{
  max-width:1300px;
  margin:auto;
  padding:2rem;
}

.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:1rem;
  margin-bottom:2rem;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1.5rem;
}

.shop-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:1rem;
}

.shop-card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1.2rem;
  cursor:pointer;
  transition:.25s;
}

.shop-card:hover{
  transform:translateY(-5px);
  border-color:#60a5fa;
}

.panel{
  position:fixed;
  bottom:-100%;
  left:0;
  right:0;
  background:#1e293b;
  padding:2rem;
  border-top-left-radius:20px;
  border-top-right-radius:20px;
  transition:.35s;
  z-index:999;
}

.panel.active{
  bottom:0;
}

.close{
  margin-top:1.5rem;
  text-align:center;
  cursor:pointer;
  color:#60a5fa;
  font-weight:600;
}
</style>
</head>

<body>

<header>
  <h2>Owner Dashboard</h2>
  <div>
    <button onclick="location.href='create-shopkeeper.html'">+ Shopkeeper</button>
    <button onclick="location.href='create-worker.html'">+ Worker</button>
  </div>
</header>

<main>

<div class="stats">
  <div class="card">Total Revenue<br><b id="revenue">₹0</b></div>
  <div class="card">Shopkeepers<br><b id="shopkeepers">0</b></div>
  <div class="card">Workers<br><b id="workers">0</b></div>
  <div class="card">Jobs<br><b id="jobs">0</b></div>
</div>

<h3>Your Shops</h3>
<div class="shop-grid" id="shopList"></div>

</main>

<div id="panel" class="panel">
  <div id="panelContent"></div>
  <div class="close" onclick="closePanel()">Close</div>
</div>

<script type="module">
import { db } from "../js/firebase.js";
import {
  collection,
  getDocs,
  query,
  where,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* OWNER CHECK */
const user = JSON.parse(localStorage.getItem("currentUser"));
if (!user || user.role !== "OWNER") {
  window.location.replace("../login.html");
}

const shopList = document.getElementById("shopList");
const panel = document.getElementById("panel");
const panelContent = document.getElementById("panelContent");

/* LOAD STATS */
async function loadStats(){

  const shopkeepersSnap = await getDocs(
    query(collection(db,"users"),where("role","==","SHOPKEEPER"))
  );
  document.getElementById("shopkeepers").innerText = shopkeepersSnap.size;

  const workersSnap = await getDocs(
    query(collection(db,"users"),where("role","==","WORKER"))
  );
  document.getElementById("workers").innerText = workersSnap.size;

  const jobsSnap = await getDocs(collection(db,"jobs"));
  document.getElementById("jobs").innerText = jobsSnap.size;

  let total=0;
  const salesSnap = await getDocs(collection(db,"sales"));
  salesSnap.forEach(d=> total+=Number(d.data().amount||0));
  document.getElementById("revenue").innerText="₹"+total;
}

/* LOAD SHOPS */
async function loadShops(){
  const snap = await getDocs(collection(db,"shops"));
  shopList.innerHTML="";

  snap.forEach(docSnap=>{
    const shop = docSnap.data();

    const card = document.createElement("div");
    card.className = "shop-card";
    card.innerHTML = `
      <b>${shop.shopName}</b><br>
      ${shop.city || ""}
    `;

    card.addEventListener("click", ()=>{
      viewShop(docSnap.id);
    });

    shopList.appendChild(card);
  });
}

/* VIEW SHOP DETAILS */
async function viewShop(id){

  const shopDoc = await getDoc(doc(db,"shops",id));
  const shop = shopDoc.data();

  const shopkeeperSnap = await getDocs(
    query(collection(db,"users"),
      where("shopId","==",id),
      where("role","==","SHOPKEEPER"))
  );

  const workerSnap = await getDocs(
    query(collection(db,"users"),
      where("shopId","==",id),
      where("role","==","WORKER"))
  );

  const jobsSnap = await getDocs(
    query(collection(db,"jobs"),
      where("shopId","==",id))
  );

  let revenue=0;
  const salesSnap = await getDocs(
    query(collection(db,"sales"),
      where("shopId","==",id))
  );
  salesSnap.forEach(d=> revenue+=Number(d.data().amount||0));

  panelContent.innerHTML = `
    <h3>${shop.shopName}</h3>
    <p><b>City:</b> ${shop.city || "—"}</p>
    <p><b>Shopkeeper:</b> ${shopkeeperSnap.docs[0]?.data()?.name || "Not Assigned"}</p>
    <p><b>Total Workers:</b> ${workerSnap.size}</p>
    <p><b>Total Jobs:</b> ${jobsSnap.size}</p>
    <p><b>Total Revenue:</b> ₹${revenue}</p>
  `;

  panel.classList.add("active");
}

window.closePanel = ()=> panel.classList.remove("active");

/* INIT */
loadStats();
loadShops();
</script>

</body>
</html>
