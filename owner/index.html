<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Owner Dashboard</title>

<style>
:root {
  --bg:#0f172a;
  --card:rgba(30,41,59,.7);
  --border:rgba(148,163,184,.18);
  --text:#f1f5f9;
  --radius:16px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
}
header{
  padding:2rem;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
button{
  padding:.6rem 1rem;
  border:none;
  border-radius:10px;
  cursor:pointer;
  background:#1d4ed8;
  color:white;
}
main{
  max-width:1300px;
  margin:auto;
  padding:2rem;
}
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:1rem;
  margin-bottom:2rem;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1.5rem;
}
.shop-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:1rem;
}
.shop-card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1.2rem;
  cursor:pointer;
}
.panel{
  position:fixed;
  bottom:-100%;
  left:0;
  right:0;
  background:#1e293b;
  padding:1.5rem;
  border-top-left-radius:20px;
  border-top-right-radius:20px;
  transition:.3s;
}
.panel.active{bottom:0}
.close{
  margin-top:1rem;
  text-align:center;
  cursor:pointer;
  color:#60a5fa;
}
input,select{
  width:100%;
  padding:.6rem;
  margin:.5rem 0;
  border-radius:8px;
  border:1px solid #334155;
  background:#0f172a;
  color:white;
}
</style>
</head>

<body>

<header>
  <h2>Owner Dashboard</h2>
  <div>

<button onclick="location.href='create-shopkeeper.html'">
  + Shopkeeper
</button>

<button onclick="location.href='create-worker.html'">
  + Worker
</button>

</header>

<main>

<div class="stats">
  <div class="card">Total Revenue<br><b id="revenue">₹0</b></div>
  <div class="card">Shopkeepers<br><b id="shopkeepers">0</b></div>
  <div class="card">Workers<br><b id="workers">0</b></div>
  <div class="card">Jobs<br><b id="jobs">0</b></div>
</div>

<h3>Your Shops</h3>
<div class="shop-grid" id="shopList"></div>

</main>

<div id="panel" class="panel">
  <div id="panelContent"></div>
  <div class="close" onclick="closePanel()">Close</div>
</div>

<script type="module">
import { db } from "../js/firebase.js";
import {
  collection, getDocs, addDoc, query, where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* OWNER CHECK */
const user = JSON.parse(localStorage.getItem("currentUser"));
if (!user || user.role !== "OWNER") {
  window.location.replace("../login.html");
}

const shopList = document.getElementById("shopList");
const panel = document.getElementById("panel");
const panelContent = document.getElementById("panelContent");

/* LOAD STATS */
async function loadStats(){
  document.getElementById("shopkeepers").innerText =
    (await getDocs(query(collection(db,"users"),where("role","==","SHOPKEEPER")))).size;

  document.getElementById("workers").innerText =
    (await getDocs(query(collection(db,"users"),where("role","==","WORKER")))).size;

  document.getElementById("jobs").innerText =
    (await getDocs(collection(db,"jobs"))).size;

  let total=0;
  const sales = await getDocs(collection(db,"sales"));
  sales.forEach(d=> total+=Number(d.data().amount||0));
  document.getElementById("revenue").innerText="₹"+total;
}

/* LOAD SHOPS */
async function loadShops(){
  const snap = await getDocs(collection(db,"shops"));
  shopList.innerHTML="";
  snap.forEach(docSnap=>{
    const shop = docSnap.data();
    shopList.innerHTML += `
      <div class="shop-card" onclick="viewShop('${docSnap.id}','${shop.shopName}')">
        <b>${shop.shopName}</b><br>
        Click to view details
      </div>
    `;
  });
}

/* VIEW SHOP INFO */
window.viewShop = async(id,name)=>{
  const workers = await getDocs(query(collection(db,"users"),
    where("shopId","==",id),
    where("role","==","WORKER")
  ));

  const jobs = await getDocs(query(collection(db,"jobs"),
    where("shopId","==",id)
  ));

  panelContent.innerHTML = `
    <h3>${name}</h3>
    <p>Workers: ${workers.size}</p>
    <p>Total Jobs: ${jobs.size}</p>
  `;
  panel.classList.add("active");
}

window.closePanel = ()=> panel.classList.remove("active");

/* CREATE SHOP */
window.openCreateShop = ()=>{
  panelContent.innerHTML = `
    <h3>Create Shop</h3>
    <input id="shopName" placeholder="Shop Name"/>
    <button onclick="createShop()">Create</button>
  `;
  panel.classList.add("active");
}
window.createShop = async()=>{
  const name = document.getElementById("shopName").value;
  if(!name) return alert("Enter name");
  await addDoc(collection(db,"shops"),{shopName:name});
  closePanel();
  loadShops();
}

/* CREATE SHOPKEEPER */
window.openCreateShopkeeper = async()=>{
  const shops = await getDocs(collection(db,"shops"));
  let options="";
  shops.forEach(s=> options+=`<option value="${s.id}">${s.data().shopName}</option>`);

  panelContent.innerHTML = `
    <h3>Create Shopkeeper</h3>
    <input id="skName" placeholder="Name"/>
    <select id="skShop">${options}</select>
    <button onclick="createShopkeeper()">Create</button>
  `;
  panel.classList.add("active");
}
window.createShopkeeper = async()=>{
  await addDoc(collection(db,"users"),{
    name:document.getElementById("skName").value,
    role:"SHOPKEEPER",
    shopId:document.getElementById("skShop").value
  });
  closePanel();
  loadStats();
}

/* CREATE WORKER */
window.openCreateWorker = async()=>{
  const shops = await getDocs(collection(db,"shops"));
  let options="";
  shops.forEach(s=> options+=`<option value="${s.id}">${s.data().shopName}</option>`);

  panelContent.innerHTML = `
    <h3>Create Worker</h3>
    <input id="wName" placeholder="Name"/>
    <select id="wShop">${options}</select>
    <button onclick="createWorker()">Create</button>
  `;
  panel.classList.add("active");
}
window.createWorker = async()=>{
  await addDoc(collection(db,"users"),{
    name:document.getElementById("wName").value,
    role:"WORKER",
    shopId:document.getElementById("wShop").value
  });
  closePanel();
  loadStats();
}

/* INIT */
loadStats();
loadShops();

</script>

</body>
</html>
