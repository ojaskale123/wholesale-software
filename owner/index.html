<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Owner Dashboard</title>

<style>
:root {
  --bg:#0f172a;
  --card:rgba(30,41,59,.75);
  --border:rgba(148,163,184,.18);
  --text:#f1f5f9;
  --radius:16px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
}
header{
  padding:2rem;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
button{
  padding:.6rem 1rem;
  border:none;
  border-radius:10px;
  cursor:pointer;
  background:#1d4ed8;
  color:white;
  margin-left:.5rem;
}
.logout{background:#ef4444}
main{
  max-width:1300px;
  margin:auto;
  padding:2rem;
}
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:1rem;
  margin-bottom:2rem;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1.5rem;
  cursor:pointer;
  transition:.25s;
}
.card:hover{
  transform:translateY(-5px);
  border-color:#60a5fa;
}
.shop-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:1rem;
}
.shop-card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1.2rem;
}
.panel{
  position:fixed;
  bottom:-100%;
  left:0;
  right:0;
  background:#1e293b;
  padding:2rem;
  border-top-left-radius:20px;
  border-top-right-radius:20px;
  transition:.35s;
  z-index:999;
  max-height:70vh;
  overflow:auto;
}
.panel.active{bottom:0}
.close{
  margin-top:1.5rem;
  text-align:center;
  cursor:pointer;
  color:#60a5fa;
  font-weight:600;
}
</style>
</head>

<body>

<header>
  <h2>Owner Dashboard</h2>
  <div>
    <button onclick="location.href='create-shopkeeper.html'">+ Shopkeeper</button>
    <button onclick="location.href='create-worker.html'">+ Worker</button>
    <button id="logoutBtn" class="logout">Logout</button>
  </div>
</header>

<main>

<div class="stats">

  <div class="card" onclick="openRevenue()">
    Total Revenue<br><b id="revenue">₹0</b>
  </div>

  <div class="card" onclick="openShopkeepers()">
    Shopkeepers<br><b id="shopkeepers">0</b>
  </div>

  <div class="card" onclick="openWorkers()">
    Workers<br><b id="workers">0</b>
  </div>

  <div class="card" onclick="openJobs()">
    Jobs<br><b id="jobs">0</b>
  </div>

  <div class="card" onclick="location.href='stock.html'">
    Total Stock Items<br><b id="stockCount">0</b>
  </div>

  <div class="card" onclick="location.href='history.html'">
    History<br><b>View Activity</b>
  </div>

  <div class="card" onclick="location.href='sell-overview.html'">
    Sell Overview<br><b>View All Sales</b>
  </div>

</div>

<h3>Your Shops</h3>
<div class="shop-grid" id="shopList"></div>

</main>

<div id="panel" class="panel">
  <div id="panelContent"></div>
  <div class="close" onclick="closePanel()">Close</div>
</div>

<script type="module">
import { db, auth } from "../js/firebase.js";
import {
  collection,
  getDocs,
  query,
  where,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { signOut }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* AUTH CHECK */
const user = JSON.parse(localStorage.getItem("currentUser"));
if (!user || user.role !== "OWNER") {
  location.href="../login.html";
}

/* LOGOUT */
document.getElementById("logoutBtn").onclick=async()=>{
  try{await signOut(auth);}catch(e){}
  localStorage.clear();
  location.href="../login.html";
};

const panel=document.getElementById("panel");
const panelContent=document.getElementById("panelContent");
const shopList=document.getElementById("shopList");

/* REALTIME STATS */
onSnapshot(collection(db,"users"),snap=>{
  let s=0,w=0;
  snap.forEach(d=>{
    if(d.data().role==="SHOPKEEPER") s++;
    if(d.data().role==="WORKER") w++;
  });
  shopkeepers.innerText=s;
  workers.innerText=w;
});

onSnapshot(collection(db,"jobs"),snap=>{
  jobs.innerText=snap.size;
});

onSnapshot(collection(db,"sales"),snap=>{
  let total=0;
  snap.forEach(d=> total+=Number(d.data().amount||0));
  revenue.innerText="₹"+total.toLocaleString();
});

onSnapshot(collection(db,"stock"),snap=>{
  stockCount.innerText=snap.size;
});

/* OPEN FUNCTIONS */

window.openRevenue=async()=>{
  const snap=await getDocs(collection(db,"sales"));
  panelContent.innerHTML=`
    <h3>Total Revenue</h3>
    <p>Total Sales: ${snap.size}</p>
    <p>Revenue: ${revenue.innerText}</p>
  `;
  panel.classList.add("active");
};

window.openShopkeepers=async()=>{
  const usersSnap=await getDocs(query(
    collection(db,"users"),
    where("role","==","SHOPKEEPER")
  ));
  const shopsSnap=await getDocs(collection(db,"shops"));
  const shops=shopsSnap.docs.map(d=>({id:d.id,...d.data()}));

  let html=`<h3>Shopkeepers</h3>
            <p>Total: ${usersSnap.size}</p><br>`;

  usersSnap.forEach(docSnap=>{
    const u=docSnap.data();
    const shop=shops.find(s=>s.id===u.shopId);
    html+=`
      <div style="margin-bottom:8px">
        <b>${u.name}</b>
        <small style="color:#94a3b8">
          • Shop: ${shop?.shopName || "Not Assigned"}
        </small>
      </div>
    `;
  });

  panelContent.innerHTML=html;
  panel.classList.add("active");
};

window.openWorkers=async()=>{
  const usersSnap=await getDocs(query(
    collection(db,"users"),
    where("role","==","WORKER")
  ));
  const shopsSnap=await getDocs(collection(db,"shops"));
  const shops=shopsSnap.docs.map(d=>({id:d.id,...d.data()}));

  let html=`<h3>Workers</h3>
            <p>Total: ${usersSnap.size}</p><br>`;

  usersSnap.forEach(docSnap=>{
    const u=docSnap.data();
    const shop=shops.find(s=>s.id===u.shopId);
    html+=`
      <div style="margin-bottom:8px">
        <b>${u.name}</b>
        <small style="color:#94a3b8">
          • Shop: ${shop?.shopName || "Not Assigned"}
        </small>
      </div>
    `;
  });

  panelContent.innerHTML=html;
  panel.classList.add("active");
};

window.openJobs=async()=>{
  const jobsSnap=await getDocs(collection(db,"jobs"));
  let total=0, delivered=0, inProgress=0;

  jobsSnap.forEach(docSnap=>{
    total++;
    const j=docSnap.data();
    if(j.status==="DELIVERED") delivered++;
    if(j.status==="IN_PROGRESS") inProgress++;
  });

  panelContent.innerHTML=`
    <h3>Jobs Overview</h3>
    <p><b>Total Jobs:</b> ${total}</p>
    <p><b>Delivered:</b> ${delivered}</p>
    <p><b>In Progress:</b> ${inProgress}</p>
  `;

  panel.classList.add("active");
};

window.closePanel=()=>panel.classList.remove("active");

/* LOAD SHOPS */
async function loadShops(){
  const snap=await getDocs(collection(db,"shops"));
  shopList.innerHTML="";
  snap.forEach(docSnap=>{
    const s=docSnap.data();
    const div=document.createElement("div");
    div.className="shop-card";
    div.innerHTML=`<b>${s.shopName}</b><br>${s.city||""}`;
    shopList.appendChild(div);
  });
}
loadShops();
</script>

</body>
</html>