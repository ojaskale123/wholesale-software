<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Owner Dashboard</title>

<style>
:root { --primary:#203a43; --bg:#f4f6f8; }
body {
  margin:0;
  font-family:Segoe UI, Arial, sans-serif;
  background:linear-gradient(180deg,#0f2027,#203a43,#2c5364);
}
.hero {
  padding:32px 26px 42px;
  color:white;
}
.hero h1 { margin:0;font-size:32px; }
.hero p { margin-top:6px;font-size:14px;color:#cfd8dc; }
.create-btn {
  margin-top:22px;
  background:linear-gradient(135deg,#2ecc71,#27ae60);
  padding:14px 20px;
  border-radius:20px;
  cursor:pointer;
  display:inline-block;
  font-weight:600;
}
.dashboard {
  background:var(--bg);
  border-radius:30px 30px 0 0;
  padding:30px;
  min-height:100vh;
}

/* SHOPS */
.shop-strip {
  display:flex;
  gap:18px;
  overflow-x:auto;
  margin-bottom:36px;
}
.shop-card {
  min-width:260px;
  background:white;
  border-radius:20px;
  padding:18px;
  box-shadow:0 10px 28px rgba(0,0,0,.15);
  cursor:pointer;
  transition:.2s;
}
.shop-card:hover { transform:translateY(-4px); }

/* CARDS */
.card-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-bottom:45px;
}
.card {
  background:white;
  border-radius:20px;
  padding:22px;
  box-shadow:0 10px 26px rgba(0,0,0,.15);
  cursor:pointer;
}
.count { font-size:34px;font-weight:700;color:var(--primary); }
.label { font-size:14px;color:#666; }

/* TABLE */
table {
  width:100%;
  background:white;
  border-radius:18px;
  border-collapse:collapse;
}
th {
  background:var(--primary);
  color:white;
  padding:14px;
}
td {
  padding:12px;
  font-size:13px;
  border-bottom:1px solid #eee;
  vertical-align:top;
}

/* POPUPS */
.overlay {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  z-index:999;
}
.popup {
  display:none;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:white;
  width:90%;
  max-width:900px;
  border-radius:20px;
  padding:22px;
  z-index:1000;
}
</style>
</head>

<body>

<div class="hero">
  <h1>Owner Dashboard</h1>
  <p>All shops, staff, sales & activity</p>
  <div class="create-btn" onclick="location.href='create.html'">âž• Create</div>
</div>

<div class="dashboard">

<h3>Shops</h3>
<div class="shop-strip" id="shopStrip"></div>

<div class="card-grid">

  <div class="card" onclick="location.href='stock.html'">
    <div class="count">ðŸ“¦</div>
    <div class="label">Stock</div>
  </div>

  <div class="card" onclick="location.href='revenue.html'">
    <div class="count" id="totalRevenue">0</div>
    <div class="label">Total Revenue</div>
  </div>

  <div class="card" onclick="openSmallPopup('shopkeepersPopup')">
    <div class="count" id="shopkeeperCount">0</div>
    <div class="label">Shopkeepers</div>
  </div>

  <div class="card" onclick="openSmallPopup('workersPopup')">
    <div class="count" id="workerCount">0</div>
    <div class="label">Workers</div>
  </div>

  <div class="card" onclick="location.href='jobs.html'">
    <div class="count" id="jobCount">0</div>
    <div class="label">Jobs</div>
  </div>

  <div class="card" onclick="location.href='history.html'">
    <div class="count">ðŸ•˜</div>
    <div class="label">History</div>
  </div>

</div>

<h3>Recent Activity</h3>
<table>
<thead>
<tr>
  <th>User</th>
  <th>Role</th>
  <th>Activity</th>
  <th>Time</th>
</tr>
</thead>
<tbody id="auditTable"></tbody>
</table>

</div>

<!-- OVERLAY -->
<div class="overlay" id="overlay"></div>

<!-- SMALL POPUPS -->
<div class="popup" id="shopkeepersPopup">
  <h3>Shopkeepers</h3>
  <div id="shopkeepersList"></div>
</div>

<div class="popup" id="workersPopup">
  <h3>Workers</h3>
  <div id="workersList"></div>
</div>

<script type="module">
import { DB } from "../db/fakeDB.js";

/* COUNTS */
shopkeeperCount.innerText = DB.users.filter(u=>u.role==="SHOPKEEPER").length;
workerCount.innerText = DB.users.filter(u=>u.role==="WORKER").length;
jobCount.innerText = DB.tasks?.length || 0;

/* TOTAL REVENUE = SELL + DELIVERED JOBS */
const sellRevenue = (DB.sales || []).reduce((s,x)=>s+(x.total||0),0);
const jobRevenue = (DB.tasks || [])
  .filter(t=>t.status==="DONE_DELIVERED")
  .reduce((s,x)=>s+(Number(x.expectedCost)||0),0);

totalRevenue.innerText = sellRevenue + jobRevenue;

/* SHOPS */
DB.shops.forEach(shop=>{
  const card=document.createElement("div");
  card.className="shop-card";
  card.innerHTML=`<h4>${shop.name}</h4>`;
  card.onclick=()=>openShopPopup(shop.id);
  shopStrip.appendChild(card);
});

/* SMALL POPUP LISTS */
shopkeepersList.innerHTML = DB.users
  .filter(u=>u.role==="SHOPKEEPER")
  .map(u=>`<p><b>${u.name}</b> (${u.phone})</p>`)
  .join("") || "<p>No shopkeepers</p>";

workersList.innerHTML = DB.users
  .filter(u=>u.role==="WORKER")
  .map(u=>`<p><b>${u.name}</b> (${u.phone})</p>`)
  .join("") || "<p>No workers</p>";

/* RECENT ACTIVITY */
DB.auditLogs.slice().reverse().forEach(log=>{
  const user = DB.users.find(u=>u.id===log.userId);
  const shop = DB.shops.find(s=>s.id===log.shopId);

  let amountHTML = "";

  if (log.actionType === "SELL") {
    const sale = DB.sales.find(s=>s.timestamp===log.timestamp);
    if (sale) amountHTML = `<div><b>Amount:</b> â‚¹${sale.total}</div>`;
  }

  if (log.actionType === "WORK_DONE_DELIVERED") {
    const job = DB.tasks.find(
      t=>t.shopId===log.shopId && log.action.includes(t.device)
    );
    if (job?.expectedCost)
      amountHTML = `<div><b>Job Amount:</b> â‚¹${job.expectedCost}</div>`;
  }

  auditTable.innerHTML += `
    <tr>
      <td>
        <b>${user?.name || "System"}</b>
        <div style="font-size:12px;color:#666;">
          ${shop?.name || "-"}
        </div>
      </td>
      <td>${log.role || "-"}</td>
      <td>
        ${log.action}
        ${amountHTML}
      </td>
      <td>${new Date(log.timestamp).toLocaleString()}</td>
    </tr>
  `;
});

/* POPUPS */
window.openSmallPopup=id=>{
  overlay.style.display="block";
  document.getElementById(id).style.display="block";
};

overlay.onclick=()=>{
  overlay.style.display="none";
  document.querySelectorAll(".popup").forEach(p=>p.style.display="none");
};

window.openShopPopup=shopId=>{
  alert("Shop popup can be extended later");
};
</script>

</body>
</html>
