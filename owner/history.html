<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>System History</title>

<style>
:root {
  --primary:#203a43;
  --bg:#f4f6f8;
}
body {
  margin:0;
  font-family:Segoe UI, Arial, sans-serif;
  background:var(--bg);
  padding:30px;
}

h2 {
  margin-bottom:20px;
  color:var(--primary);
}

/* FILTER BAR */
.filters {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
  margin-bottom:25px;
}
select, input {
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:14px;
}

/* TIMELINE */
.timeline {
  display:flex;
  flex-direction:column;
  gap:14px;
}

.log {
  background:white;
  padding:16px 18px;
  border-radius:14px;
  box-shadow:0 8px 20px rgba(0,0,0,.12);
}

.log b {
  font-size:15px;
  color:#111;
}

.log small {
  display:block;
  margin-top:6px;
  color:#666;
  font-size:12px;
}

/* BADGES */
.badge {
  display:inline-block;
  padding:5px 10px;
  border-radius:20px;
  font-size:11px;
  font-weight:700;
  margin-left:8px;
  color:white;
}

.BUY { background:#2980b9; }
.SELL { background:#27ae60; }

.WORK_CREATED { background:#7f8c8d; }
.WORK_IN_PROGRESS { background:#f39c12; }
.WORK_DONE_NOT_DELIVERED { background:#8e44ad; }
.WORK_DONE_DELIVERED { background:#2ecc71; }

.SHOP_CREATED,
.SHOPKEEPER_CREATED,
.WORKER_CREATED { background:#34495e; }
.SYSTEM { background:#95a5a6; }
</style>
</head>

<body>

<h2>System Activity History</h2>

<div class="filters">
  <select id="shopFilter">
    <option value="">All Shops</option>
  </select>

  <select id="roleFilter">
    <option value="">All Roles</option>
    <option value="SHOPKEEPER">Shopkeeper</option>
    <option value="WORKER">Worker</option>
  </select>

  <select id="typeFilter">
    <option value="">All Activities</option>
    <option value="BUY">Buy</option>
    <option value="SELL">Sell</option>
    <option value="WORK_CREATED">Floating Work</option>
    <option value="WORK_IN_PROGRESS">In Progress</option>
    <option value="WORK_DONE_NOT_DELIVERED">Done (Not Delivered)</option>
    <option value="WORK_DONE_DELIVERED">Done & Delivered</option>
    <option value="SHOP_CREATED">Shop Created</option>
    <option value="SHOPKEEPER_CREATED">Shopkeeper Created</option>
    <option value="WORKER_CREATED">Worker Created</option>
  </select>

  <!-- âœ… SINGLE DATE -->
  <input type="date" id="dateFilter">
</div>

<div class="timeline" id="historyList"></div>

<script type="module">
import { DB } from "../db/fakeDB.js";

/* LOAD SHOPS */
shopFilter.innerHTML += DB.shops
  .map(s => `<option value="${s.id}">${s.name}</option>`)
  .join("");

function inferType(log) {
  if (log.actionType) return log.actionType;

  const a = log.action.toLowerCase();
  if (a.includes("sell")) return "SELL";
  if (a.includes("buy")) return "BUY";
  if (a.includes("repair job created")) return "WORK_CREATED";
  if (a.includes("accepted")) return "WORK_IN_PROGRESS";
  if (a.includes("delivered")) return "WORK_DONE_DELIVERED";
  if (a.includes("completed")) return "WORK_DONE_NOT_DELIVERED";
  if (a.includes("shop created")) return "SHOP_CREATED";
  if (a.includes("shopkeeper")) return "SHOPKEEPER_CREATED";
  if (a.includes("worker")) return "WORKER_CREATED";
  return "SYSTEM";
}

function renderHistory() {
  historyList.innerHTML = "";

  DB.auditLogs
    .filter(log => {
      const type = inferType(log);

      if (shopFilter.value && log.shopId && log.shopId !== shopFilter.value) return false;
      if (roleFilter.value && log.role !== roleFilter.value) return false;
      if (typeFilter.value && type !== typeFilter.value) return false;

      if (dateFilter.value) {
        const logDate = new Date(log.timestamp).toISOString().slice(0,10);
        if (logDate !== dateFilter.value) return false;
      }

      return true;
    })
    .slice()
    .reverse()
    .forEach(log => {
      const user = DB.users.find(u => u.id === log.userId);
      const shop = DB.shops.find(s => s.id === log.shopId);
      const type = inferType(log);

      historyList.innerHTML += `
        <div class="log">
          <b>${user?.name || "System"}</b>
          <span class="badge ${type}">${type.replaceAll("_"," ")}</span>
          <div>${log.action}</div>
          <small>
            Role: ${log.role || "-"} |
            Shop: ${shop?.name || "-"} |
            ${new Date(log.timestamp).toLocaleString()}
          </small>
        </div>
      `;
    });
}

shopFilter.onchange =
roleFilter.onchange =
typeFilter.onchange =
dateFilter.onchange = renderHistory;

renderHistory();
</script>

</body>
</html>
