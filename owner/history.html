<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner · Master History</title>

<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --border:#334155;
  --text:#e2e8f0;
  --muted:#94a3b8;
  --accent:#10b981;
  --danger:#ef4444;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:system-ui}

header{
  padding:1rem 1.5rem;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

button{
  background:var(--danger);
  border:none;
  padding:.5rem 1rem;
  border-radius:8px;
  color:white;
  cursor:pointer;
}

.container{
  max-width:1400px;
  margin:auto;
  padding:2rem;
}

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:1rem;
  margin-bottom:2rem;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  padding:1.2rem;
  border-radius:12px;
}

.section{
  margin-top:2rem;
}

.section h3{
  margin-bottom:1rem;
}

.item{
  background:#0f172a;
  border:1px solid var(--border);
  padding:1rem;
  border-radius:10px;
  margin-bottom:.8rem;
  font-size:.9rem;
}

.green{color:var(--accent)}
.red{color:var(--danger)}
.muted{color:var(--muted)}
</style>
</head>

<body>

<header>
  <h2>Owner · Master History Dashboard</h2>
  <button onclick="location.href='index.html'">Back</button>
</header>

<div class="container">

<div class="cards">
  <div class="card"><h4>Total Revenue</h4><p id="totalRevenue">₹0</p></div>
  <div class="card"><h4>Total Jobs</h4><p id="totalJobs">0</p></div>
  <div class="card"><h4>Total Attendance Records</h4><p id="totalAttendance">0</p></div>
  <div class="card"><h4>Total Stock Items</h4><p id="totalStock">0</p></div>
</div>

<div id="content"></div>

</div>

<script type="module">
import { db } from "../js/firebase.js";
import {
  collection,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* SAFE REVENUE FIELD */
function getRevenueValue(s){
  return s.total || s.amount || s.finalAmount || s.grandTotal || 0;
}

async function loadData(){

  const jobsSnap = await getDocs(collection(db,"jobs"));
  const salesSnap = await getDocs(collection(db,"sales"));
  const attendanceSnap = await getDocs(collection(db,"attendance"));
  const stockSnap = await getDocs(collection(db,"stock"));
  const auditSnap = await getDocs(collection(db,"auditLogs"));

  const JOBS = jobsSnap.docs.map(d=>d.data());
  const SALES = salesSnap.docs.map(d=>d.data());
  const ATTENDANCE = attendanceSnap.docs.map(d=>d.data());
  const STOCK = stockSnap.docs.map(d=>d.data());
  const AUDIT = auditSnap.docs.map(d=>d.data());

  /* SUMMARY */
  const totalRevenue = SALES.reduce((sum,s)=>sum+getRevenueValue(s),0);

  document.getElementById("totalRevenue").innerText="₹"+totalRevenue;
  document.getElementById("totalJobs").innerText=JOBS.length;
  document.getElementById("totalAttendance").innerText=ATTENDANCE.length;
  document.getElementById("totalStock").innerText=STOCK.length;

  const content = document.getElementById("content");

  content.innerHTML=`

  <div class="section">
    <h3>Jobs</h3>
    ${JOBS.map(j=>`
      <div class="item">
        <strong>${j.device||"-"}</strong>
        <div>Status: ${j.status||"-"}</div>
        <div>Shop: ${j.shopId||"-"}</div>
        <div>Assigned To: ${j.assignedTo||"Unassigned"}</div>
      </div>
    `).join("")}
  </div>

  <div class="section">
    <h3>Revenue</h3>
    ${SALES.map(s=>`
      <div class="item">
        <strong class="green">₹${getRevenueValue(s)}</strong>
        <div>Shop: ${s.shopId||"-"}</div>
        <div>Sold By: ${s.soldBy||s.userId||"-"}</div>
      </div>
    `).join("")}
  </div>

  <div class="section">
    <h3>Attendance</h3>
    ${ATTENDANCE.map(a=>`
      <div class="item">
        <strong>${a.userId||"-"}</strong>
        <div>Shop: ${a.shopId||"-"}</div>
        <div>Check-In: ${a.checkIn ? new Date(a.checkIn.seconds*1000).toLocaleString():"-"}</div>
        <div>Check-Out: ${a.checkOut ? new Date(a.checkOut.seconds*1000).toLocaleString():"-"}</div>
      </div>
    `).join("")}
  </div>

  <div class="section">
    <h3>Stock</h3>
    ${STOCK.map(s=>`
      <div class="item">
        <strong>${s.name||"-"}</strong>
        <div>Qty: ${s.quantity||0}</div>
        <div>Shop: ${s.shopId||"-"}</div>
      </div>
    `).join("")}
  </div>

  <div class="section">
    <h3>Audit Logs</h3>
    ${AUDIT.map(a=>`
      <div class="item">
        <strong>${a.role||"-"}</strong>
        <div>${a.action||"-"}</div>
        <div>Shop: ${a.shopId||"-"}</div>
      </div>
    `).join("")}
  </div>
  `;
}

loadData();
</script>

</body>
</html>