<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sell Overview</title>

<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --border:#334155;
  --text:#e2e8f0;
  --muted:#94a3b8;
  --accent:#10b981;
  --radius:16px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
  padding:2rem;
}
h2{
  text-align:center;
  margin-bottom:2rem;
  background:linear-gradient(90deg,#93c5fd,#c7d2fe);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:1rem;
  margin-bottom:2rem;
}
.stat-card{
  background:var(--card);
  padding:1.5rem;
  border-radius:var(--radius);
  border:1px solid var(--border);
}
.stat-card h3{
  font-size:1rem;
  color:var(--muted);
}
.stat-card b{
  font-size:1.8rem;
  color:var(--accent);
}
.filters{
  display:flex;
  gap:1rem;
  flex-wrap:wrap;
  margin-bottom:2rem;
}
select,input{
  padding:.7rem 1rem;
  border-radius:10px;
  border:1px solid var(--border);
  background:#111827;
  color:white;
}
.sales-list{
  display:flex;
  flex-direction:column;
  gap:1rem;
}
.sale-card{
  background:var(--card);
  padding:1.2rem;
  border-radius:var(--radius);
  border:1px solid var(--border);
}
.sale-card b{
  font-size:1.1rem;
}
.sale-card small{
  color:var(--muted);
}
</style>
</head>

<body>

<h2>Sell Overview</h2>

<div class="stats">
  <div class="stat-card">
    <h3>Total Revenue</h3>
    <b id="totalRevenue">₹0</b>
  </div>

  <div class="stat-card">
    <h3>Today's Revenue</h3>
    <b id="todayRevenue">₹0</b>
  </div>

  <div class="stat-card">
    <h3>Total Sales</h3>
    <b id="totalSales">0</b>
  </div>
</div>

<div class="filters">
  <select id="shopFilter">
    <option value="">All Shops</option>
  </select>

  <input type="date" id="dateFilter">
</div>

<div class="sales-list" id="salesList"></div>

<script type="module">
import { requireAuth } from "../auth/guard.js";
import { db } from "../js/firebase.js";
import {
  collection,
  getDocs,
  onSnapshot,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* OWNER AUTH */
requireAuth("OWNER");

const totalRevenueEl=document.getElementById("totalRevenue");
const todayRevenueEl=document.getElementById("todayRevenue");
const totalSalesEl=document.getElementById("totalSales");
const salesList=document.getElementById("salesList");
const shopFilter=document.getElementById("shopFilter");
const dateFilter=document.getElementById("dateFilter");

let ALL_SALES=[];
let SHOPS=[];

/* LOAD SHOPS */
const shopSnap=await getDocs(collection(db,"shops"));
SHOPS=shopSnap.docs.map(d=>({id:d.id,...d.data()}));
SHOPS.forEach(s=>{
  shopFilter.innerHTML+=`
    <option value="${s.id}">
      ${s.shopName || s.name}
    </option>
  `;
});

/* REALTIME SALES */
const q=query(collection(db,"sales"),orderBy("createdAt","desc"));

onSnapshot(q,(snap)=>{
  ALL_SALES=snap.docs.map(d=>({id:d.id,...d.data()}));
  render();
});

/* RENDER */
function render(){

  let totalRevenue=0;
  let todayRevenue=0;
  let totalSales=0;

  const today=new Date().toISOString().slice(0,10);

  salesList.innerHTML="";

  ALL_SALES
  .filter(sale=>{

    if(shopFilter.value && sale.shopId!==shopFilter.value)
      return false;

    if(dateFilter.value){
      const saleDate=sale.createdAt?.toDate()
        ?.toISOString()
        ?.slice(0,10);
      if(saleDate!==dateFilter.value)
        return false;
    }

    return true;
  })
  .forEach(sale=>{

    totalRevenue+=Number(sale.amount||0);
    totalSales++;

    const saleDate=sale.createdAt?.toDate()
      ?.toISOString()
      ?.slice(0,10);

    if(saleDate===today){
      todayRevenue+=Number(sale.amount||0);
    }

    const shop=SHOPS.find(s=>s.id===sale.shopId);

    salesList.innerHTML+=`
      <div class="sale-card">
        <b>₹${sale.amount}</b>
        <div>Shop: ${shop?.shopName || "—"}</div>
        <div>Customer: ${sale.customerName || "Walk-in"}</div>
        <small>
          ${sale.createdAt?.toDate().toLocaleString() || ""}
        </small>
      </div>
    `;
  });

  totalRevenueEl.innerText="₹"+totalRevenue.toLocaleString();
  todayRevenueEl.innerText="₹"+todayRevenue.toLocaleString();
  totalSalesEl.innerText=totalSales;
}

/* FILTER EVENTS */
shopFilter.onchange=render;
dateFilter.onchange=render;

</script>

</body>
</html>
