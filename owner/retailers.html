<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Retailer Management - Owner</title>

<style>
:root {
  --bg:#0f172a;
  --card-bg:rgba(30,41,59,.85);
  --border:rgba(148,163,184,.22);
  --text:#e2e8f0;
  --text-muted:#94a3b8;
  --accent-green:#10b981;
  --accent-yellow:#fbbf24;
  --radius:16px;
  --shadow:0 8px 24px rgba(0,0,0,.35);
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
}
header{
  background:linear-gradient(135deg,#1e293b,#0f172a);
  border-bottom:1px solid var(--border);
  padding:1.2rem 1.5rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.header-btn{
  background:#ef4444;
  color:white;
  border:none;
  padding:.6rem 1.3rem;
  border-radius:10px;
  cursor:pointer;
}
.container{
  max-width:1200px;
  margin:auto;
  padding:2rem 1.5rem;
}
#search{
  width:100%;
  padding:1rem;
  border-radius:12px;
  border:1px solid var(--border);
  background:#33415599;
  color:var(--text);
  margin-bottom:1.5rem;
}
.summary{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:2rem;
  text-align:center;
  margin-bottom:2rem;
  box-shadow:var(--shadow);
}
.summary h1{color:var(--accent-yellow);font-size:3rem}
.retailer-card{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1.5rem;
  margin-bottom:1.2rem;
  box-shadow:var(--shadow);
}
.pending-amount{color:var(--accent-yellow);font-weight:700}
.settle-btn{
  width:100%;
  padding:1rem;
  background:linear-gradient(135deg,#10b981,#059669);
  border:none;
  border-radius:12px;
  color:white;
  font-weight:600;
  cursor:pointer;
  margin-top:1rem;
}
.history-section{
  margin-top:1rem;
  background:#33415566;
  padding:1rem;
  border-radius:12px;
}
.history-item{color:var(--text-muted);margin:.4rem 0}
.empty{text-align:center;color:var(--text-muted);padding:2rem}
</style>
</head>

<body>

<header>
<button class="header-btn" onclick="location.href='index.html'">← Back</button>
<h2>Retailer Management</h2>
<span></span>
</header>

<div class="container">

<input id="search" placeholder="Search by name or phone...">

<div class="summary">
<h1>₹<span id="totalPending">0</span></h1>
<p>Total Pending Payments</p>
</div>

<div id="retailerList"></div>

</div>

<script type="module">

import { db } from "../js/firebase.js";
import {
  collection,
  getDocs,
  query,
  where,
  addDoc,
  doc,
  updateDoc,
  serverTimestamp,
  increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import { requireAuth } from "../auth/guard.js";

const user = requireAuth(["OWNER"]);

const searchInput = document.getElementById("search");
const totalPendingEl = document.getElementById("totalPending");
const retailerList = document.getElementById("retailerList");

let retailers = [];

/* LOAD RETAILERS */

async function loadRetailers(){

  const snap = await getDocs(collection(db,"retailers"));
  retailers = snap.docs.map(d=>({id:d.id,...d.data()}));

  let total = 0;
  retailers.forEach(r => total += r.pendingAmount || 0);
  totalPendingEl.innerText = total.toLocaleString();

  renderRetailers(retailers);
}

/* RENDER */

function renderRetailers(list){

  retailerList.innerHTML="";

  if(!list.length){
    retailerList.innerHTML=`<div class="empty">No retailers found</div>`;
    return;
  }

  list.forEach(r=>{

    retailerList.innerHTML += `
      <div class="retailer-card">
        <h3>${r.name}</h3>
        <div>Phone: ${r.phone}</div>
        <div class="pending-amount">Pending: ₹${(r.pendingAmount||0).toLocaleString()}</div>

        <button class="settle-btn" onclick="settlePayment('${r.id}',${r.pendingAmount||0})">
          Settle Payment
        </button>

        <div class="history-section" id="history-${r.id}">
          Loading history...
        </div>
      </div>
    `;

    loadHistory(r.id);
  });
}

/* LOAD HISTORY */

async function loadHistory(retailerId){

  const box = document.getElementById("history-"+retailerId);

  const snap = await getDocs(
    query(collection(db,"settlements"), where("retailerId","==",retailerId))
  );

  if(snap.empty){
    box.innerHTML = `<div class="empty">No payments yet</div>`;
    return;
  }

  box.innerHTML = "<strong>Payment History</strong>";

  snap.forEach(d=>{
    const s=d.data();
    box.innerHTML += `
      <div class="history-item">
        ₹${s.amount.toLocaleString()} — ${s.paidAt.toDate().toLocaleString()}
      </div>
    `;
  });
}

/* SETTLE */

window.settlePayment = async(id,maxPending)=>{

  const amount = Number(prompt(`Enter amount (max ₹${maxPending})`));

  if(!amount || amount<=0 || amount>maxPending){
    alert("Invalid amount");
    return;
  }

  await updateDoc(doc(db,"retailers",id),{
    pendingAmount: increment(-amount)
  });

  await addDoc(collection(db,"settlements"),{
    retailerId:id,
    amount,
    paidAt:serverTimestamp(),
    settledBy:user.uid
  });

  await addDoc(collection(db,"auditLogs"),{
    userId:user.uid,
    role:user.role,
    actionType:"SETTLEMENT",
    action:`Settled ₹${amount} for retailer`,
    timestamp:serverTimestamp()
  });

  loadRetailers();
};

/* SEARCH */

searchInput.addEventListener("input",()=>{
  const q = searchInput.value.toLowerCase();
  renderRetailers(
    retailers.filter(r =>
      r.name.toLowerCase().includes(q) || r.phone.includes(q)
    )
  );
});

loadRetailers();

</script>
</body>
</html>
