<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Available Jobs</title>

<style>
:root {
  --bg:#0f172a;
  --card-bg:rgba(30,41,59,.82);
  --border:rgba(148,163,184,.22);
  --text:#e2e8f0;
  --text-muted:#94a3b8;
  --accent-green:#10b981;
  --radius:16px;
  --shadow:0 8px 24px rgba(0,0,0,.35);
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
}
.app-header{
  background:linear-gradient(135deg,#1e293b,#0f172a);
  border-bottom:1px solid var(--border);
  padding:1rem 1.5rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.header-btn{
  background:#ef4444;
  color:white;
  border:none;
  padding:.6rem 1.3rem;
  border-radius:10px;
  cursor:pointer;
}
.container{
  max-width:900px;
  margin:auto;
  padding:1.8rem 1.5rem;
}
.job{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1.5rem;
  margin-bottom:1.2rem;
  box-shadow:var(--shadow);
}
.job h4{margin-bottom:.7rem}
.job p{color:var(--text-muted);margin:.4rem 0}
.job strong{color:var(--text)}
.accept-btn{
  width:100%;
  margin-top:1rem;
  padding:1rem;
  background:linear-gradient(135deg,#10b981,#059669);
  border:none;
  border-radius:12px;
  font-weight:600;
  color:white;
  cursor:pointer;
}
.empty{
  text-align:center;
  color:var(--text-muted);
  padding:4rem;
}
</style>
</head>

<body>

<header class="app-header">
<button class="header-btn" onclick="location.href='index.html'">← Back</button>
<h2>Available Jobs</h2>
<span></span>
</header>

<div class="container">
<div id="jobs"></div>
</div>

<script type="module">
import { db } from "../js/firebase.js";
import {
  collection,
  getDocs,
  query,
  where,
  doc,
  updateDoc,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const container = document.getElementById("jobs");
const currentUser = JSON.parse(localStorage.getItem("currentUser"));

if (!currentUser || currentUser.role !== "WORKER") {
  location.href = "/login.html";
}

/* ✅ LOAD AVAILABLE JOBS FROM FIREBASE */

async function loadJobs(){

  const q = query(
    collection(db,"jobs"),
    where("type","==","REPAIR"),
    where("status","==","OPEN"),
    where("shopId","==",currentUser.shopId)
  );

  const snap = await getDocs(q);

  if(snap.empty){
    container.innerHTML = `<div class="empty">No available repair jobs right now</div>`;
    return;
  }

  container.innerHTML="";

  snap.forEach(docSnap=>{
    const job = docSnap.data();
    const jobId = docSnap.id;

    const div = document.createElement("div");
    div.className="job";

    div.innerHTML=`
      <h4>${job.device}</h4>
      <p><strong>Issue:</strong> ${job.issue || "—"}</p>
      <p><strong>Expected Cost:</strong> ₹${job.expectedCost || "—"}</p>
      <p><strong>Customer:</strong> ${job.customerName}</p>

      <button class="accept-btn" onclick="acceptJob('${jobId}')">
        ACCEPT JOB
      </button>
    `;

    container.appendChild(div);
  });
}

/* ✅ ACCEPT JOB */

window.acceptJob = async function(jobId){

  const jobRef = doc(db,"jobs",jobId);

  await updateDoc(jobRef,{
    status:"COLLECTED",
    assignedTo:currentUser.uid,
    acceptedAt:serverTimestamp()
  });

  await addDoc(collection(db,"auditLogs"),{
    userId:currentUser.uid,
    role:"WORKER",
    shopId:currentUser.shopId,
    actionType:"WORK_ACCEPTED",
    action:`Accepted repair job (${jobId})`,
    timestamp:serverTimestamp()
  });

  location.href="jobs.html";
};

loadJobs();
</script>

</body>
</html>
