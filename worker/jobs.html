<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Jobs – Worker Panel</title>

<style>
:root {
  --bg:#0f172a;
  --card-bg:rgba(30,41,59,.85);
  --border:rgba(148,163,184,.22);
  --text:#e2e8f0;
  --text-muted:#94a3b8;
  --accent-blue:#3b82f6;
  --warning:#d97706;
  --success:#10b981;
  --purple:#8b5cf6;
  --radius:16px;
  --shadow:0 6px 20px rgba(0,0,0,.28);
}

*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:900px;
  margin:auto;
  padding:1.8rem 1.5rem;
}

.job{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1.5rem;
  margin-bottom:1.2rem;
  box-shadow:var(--shadow);
}

.job b{
  font-size:1.25rem;
  display:block;
  margin-bottom:.7rem;
}

.job div{
  color:var(--text-muted);
  margin:.45rem 0;
}

.job strong{color:var(--text)}

.status{
  display:inline-block;
  margin-top:.8rem;
  padding:.4rem 1rem;
  border-radius:20px;
  font-size:.8rem;
  font-weight:700;
  color:white;
}

.COLLECTED{background:var(--warning)}
.IN_PROGRESS{background:var(--accent-blue)}
.DONE_NOT_DELIVERED{background:var(--purple)}

.btn{
  width:100%;
  margin-top:1rem;
  padding:.9rem;
  border:none;
  border-radius:12px;
  color:white;
  font-weight:600;
  cursor:pointer;
}

.btn-start{background:#d97706}
.btn-deliver{background:#10b981}

.loading,.empty{
  text-align:center;
  color:var(--text-muted);
  padding:4rem;
}
</style>
</head>

<body>

<div class="container">
<div id="loading" class="loading">Loading your jobs...</div>
<div id="jobs"></div>
</div>

<script type="module">

import { db } from "../js/firebase.js";
import {
  collection,
  getDocs,
  getDoc,
  query,
  where,
  doc,
  updateDoc,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* AUTH */

const currentUser = JSON.parse(localStorage.getItem("currentUser"));
if(!currentUser || currentUser.role!=="WORKER"){
  location.href="/login.html";
}

const jobsContainer=document.getElementById("jobs");
const loading=document.getElementById("loading");

/* LOAD MY JOBS */

async function loadMyJobs(){

const q=query(
  collection(db,"jobs"),
  where("type","==","REPAIR"),
  where("assignedTo","==",currentUser.uid),
  where("status","!=","DONE_DELIVERED")
);

const snap=await getDocs(q);

loading.style.display="none";

if(snap.empty){
  jobsContainer.innerHTML=`<div class="empty">No active jobs assigned</div>`;
  return;
}

jobsContainer.innerHTML="";

snap.forEach(docSnap=>{

const job=docSnap.data();
const jobId=docSnap.id;

jobsContainer.innerHTML+=`
<div class="job">
<b>${job.device || "Device"}</b>

<div>Customer: <strong>${job.customerName || "-"}</strong></div>
<div>Phone: ${job.customerPhone || "-"}</div>
<div>Expected Cost: <strong>₹${job.expectedCost || 0}</strong></div>
<div>Issue: ${job.issue || "-"}</div>

<span class="status ${job.status}">
${job.status.replaceAll("_"," ")}
</span>

${job.status==="COLLECTED" ? 
`<button class="btn btn-start" onclick="startRepair('${jobId}')">START REPAIR</button>` : ""}

${job.status==="DONE_NOT_DELIVERED" ? 
`<button class="btn btn-deliver" onclick="markDelivered('${jobId}')">MARK AS DELIVERED</button>` : ""}

</div>
`;

});

}

/* START REPAIR */

window.startRepair=async(jobId)=>{

try{

const jobRef=doc(db,"jobs",jobId);

await updateDoc(jobRef,{
  status:"IN_PROGRESS",
  startedAt:serverTimestamp()
});

const jobSnap=await getDoc(jobRef);
const job=jobSnap.data();

/* audit */

await addDoc(collection(db,"auditLogs"),{
  userId:currentUser.uid,
  role:"WORKER",
  shopId:currentUser.shopId,
  actionType:"WORK_STARTED",
  action:`Repair started (${jobId})`,
  timestamp:serverTimestamp()
});

location.reload();

}catch(err){
alert(err.message);
}

};

/* MARK DELIVERED */

window.markDelivered=async(jobId)=>{

try{

const jobRef=doc(db,"jobs",jobId);

await updateDoc(jobRef,{
  status:"DONE_DELIVERED",
  deliveredAt:serverTimestamp()
});

const jobSnap=await getDoc(jobRef);
const job=jobSnap.data();

/* create sale */

await addDoc(collection(db,"sales"),{
  type:"JOB",
  shopId:job.shopId,
  userId:currentUser.uid,
  amount:Number(job.expectedCost || 0),
  jobId:jobId,
  createdAt:serverTimestamp()
});

/* audit */

await addDoc(collection(db,"auditLogs"),{
  userId:currentUser.uid,
  role:"WORKER",
  shopId:currentUser.shopId,
  actionType:"WORK_DELIVERED",
  action:`Job delivered (${jobId})`,
  timestamp:serverTimestamp()
});

location.reload();

}catch(err){
alert(err.message);
}

};

loadMyJobs();

</script>
</body>
</html>
