<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Profile</title>

<style>
:root {
  --bg:#0f172a;
  --card-bg:rgba(30,41,59,.85);
  --border:rgba(148,163,184,.22);
  --text:#e2e8f0;
  --text-muted:#94a3b8;
  --accent-purple:#8b5cf6;
  --danger:#ef4444;
  --radius:20px;
  --shadow:0 12px 32px rgba(0,0,0,.4);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui;background:var(--bg);color:var(--text);min-height:100vh}

.app-header{
  background:linear-gradient(135deg,#1e293b,#0f172a);
  border-bottom:1px solid var(--border);
  padding:1rem 1.5rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
}

.header-btn{
  background:#ef4444;
  color:white;
  border:none;
  padding:.6rem 1.3rem;
  border-radius:10px;
  cursor:pointer;
}

.app-header h2{
  font-size:1.45rem;
  background:linear-gradient(90deg,#93c5fd,#c7d2fe);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

.container{
  max-width:480px;
  margin:auto;
  padding:3rem 1.5rem 2rem;
}

.card{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:2.5rem 2rem;
  box-shadow:var(--shadow);
  text-align:center;
}

.avatar{
  width:110px;
  height:110px;
  border-radius:50%;
  background:linear-gradient(135deg,var(--accent-purple),#6d28d9);
  color:white;
  font-size:3.2rem;
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:center;
  margin:0 auto 1.2rem;
}

h3{font-size:1.6rem;margin:.5rem 0;color:white}

.role{
  font-size:1rem;
  color:var(--text-muted);
  margin-bottom:2rem;
  text-transform:capitalize;
}

.row{
  margin:1.2rem 0;
  font-size:1.05rem;
  text-align:left;
}

.row b{
  display:inline-block;
  min-width:90px;
  color:white;
}

.logout{
  margin-top:2.5rem;
  width:100%;
  padding:1.1rem;
  background:linear-gradient(135deg,var(--danger),#b91c1c);
  color:white;
  border:none;
  border-radius:12px;
  font-size:1.1rem;
  font-weight:600;
  cursor:pointer;
}
</style>
</head>

<body>

<header class="app-header">
<button class="header-btn" onclick="location.href='index.html'">‚Üê Back</button>
<h2>My Profile</h2>
<span></span>
</header>

<div class="container">
<div class="card">

<div class="avatar" id="avatar">W</div>

<h3 id="name">Loading...</h3>
<div class="role" id="role">Loading...</div>

<div class="row"><b>Phone:</b> <span id="phone">‚Äî</span></div>
<div class="row"><b>Shop:</b> <span id="shop">‚Äî</span></div>
<div class="row"><b>User ID:</b> <span id="uid">‚Äî</span></div>

<button class="logout" onclick="logout()">LOG OUT</button>

</div>
</div>

<script type="module">
import { db } from "../js/firebase.js";
import {
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üîê AUTH SAFE */
const currentUser = JSON.parse(localStorage.getItem("currentUser"));

if (!currentUser || currentUser.role !== "WORKER") {
  location.href = "/login.html";
}

const userId = currentUser.uid || currentUser.id;
const shopId = currentUser.shopId;

const nameEl = document.getElementById("name");
const roleEl = document.getElementById("role");
const phoneEl = document.getElementById("phone");
const uidEl = document.getElementById("uid");
const shopEl = document.getElementById("shop");
const avatarEl = document.getElementById("avatar");

/* LOAD PROFILE */
async function loadProfile() {
  try {

    uidEl.innerText = userId || "‚Äî";

    /* USER DOC */
    const userSnap = await getDoc(doc(db, "users", userId));

    if (userSnap.exists()) {
      const userData = userSnap.data();

      nameEl.innerText = userData.name || "Worker";
      roleEl.innerText = userData.role || "WORKER";
      phoneEl.innerText = userData.phone || "‚Äî";

      avatarEl.innerText = (userData.name || "W")[0].toUpperCase();
    } else {
      nameEl.innerText = currentUser.name || "Worker";
      roleEl.innerText = currentUser.role || "WORKER";
      phoneEl.innerText = currentUser.phone || "‚Äî";
      avatarEl.innerText = (currentUser.name || "W")[0].toUpperCase();
    }

    /* SHOP DOC */
    if (shopId) {
      const shopSnap = await getDoc(doc(db, "shops", shopId));
      if (shopSnap.exists()) {
        shopEl.innerText = shopSnap.data().name || "‚Äî";
      } else {
        shopEl.innerText = "‚Äî";
      }
    }

  } catch (error) {
    console.error("Profile load error:", error);
    alert("Failed to load profile data");
  }
}

/* LOGOUT */
window.logout = () => {
  localStorage.removeItem("currentUser");
  location.href = "/login.html";
};

loadProfile();
</script>

</body>
</html>
