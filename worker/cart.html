<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Worker Cart ‚Äì Confirm Sale</title>

  <!-- üîí UI UNCHANGED -->
  <style>
    :root {
      --bg: #0f172a;
      --card-bg: rgba(30, 41, 59, 0.82);
      --border: rgba(148, 163, 184, 0.22);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --accent-green: #10b981;
      --danger: #ef4444;
      --radius: 16px;
      --shadow: 0 8px 24px rgba(0,0,0,0.35);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui;background:var(--bg);color:var(--text)}
    .app-header{background:linear-gradient(135deg,#1e293b,#0f172a);border-bottom:1px solid var(--border);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center}
    .header-btn{background:#ef4444;color:#fff;border:none;padding:.6rem 1.3rem;border-radius:10px;cursor:pointer}
    .container{max-width:720px;margin:auto;padding:1.8rem 1.5rem}
    .item{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);padding:1.3rem;margin-bottom:1rem}
    .item b{font-size:1.2rem}
    .total{font-size:1.6rem;font-weight:700;text-align:right;margin:1.5rem 0 2rem;color:var(--accent-green)}
    input{width:100%;padding:1rem;margin-bottom:1.2rem;border-radius:12px;border:1px solid var(--border);background:rgba(51,65,85,.6);color:var(--text)}
    .btn{width:100%;padding:1.1rem;border:none;border-radius:12px;font-size:1.1rem;font-weight:600;margin-top:.8rem;cursor:pointer}
    .confirm{background:linear-gradient(135deg,#10b981,#059669);color:white}
    .cancel{background:#475569;color:white}
  </style>
</head>

<body>

<header class="app-header">
  <button class="header-btn" onclick="location.href='sell.html'">‚Üê Back</button>
  <h2>Worker Cart</h2>
  <span></span>
</header>

<div class="container">
  <div id="cartItems"></div>

  <div class="total">
    Total: ‚Çπ<span id="total">0</span>
  </div>

  <input id="custName" placeholder="Customer Name" />
  <input id="custPhone" placeholder="Customer Phone" />

  <button class="btn confirm" id="confirmBtn">CONFIRM SELL</button>
  <button class="btn cancel" onclick="cancelCart()">CANCEL</button>
</div>

<script type="module">
import { db } from "../js/firebase.js";
import {
  collection,
  addDoc,
  doc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üîê AUTH */
const user = JSON.parse(localStorage.getItem("currentUser"));
if (!user || user.role !== "WORKER") {
  location.href = "/login.html";
}

const userId = user.uid || user.id;
const shopId = user.shopId;

/* CART */
let cart = JSON.parse(localStorage.getItem("cart"));
if (!cart || !cart.items || cart.items.length === 0) {
  alert("Cart is empty");
  location.href = "sell.html";
}

const cartDiv = document.getElementById("cartItems");
const totalSpan = document.getElementById("total");
const confirmBtn = document.getElementById("confirmBtn");

let total = 0;

/* RENDER */
cart.items.forEach(i => {
  total += i.sellPrice * i.quantity;
  const d = document.createElement("div");
  d.className = "item";
  d.innerHTML = `
    <b>${i.name}</b>
    <div>Qty: ${i.quantity} √ó ‚Çπ${i.sellPrice}</div>
    <div>Subtotal: ‚Çπ${(i.sellPrice * i.quantity).toLocaleString()}</div>
  `;
  cartDiv.appendChild(d);
});
totalSpan.innerText = total.toLocaleString();

/* CONFIRM SELL */
confirmBtn.onclick = async () => {
  if (!custName.value.trim() || !custPhone.value.trim())
    return alert("Enter customer details");

  confirmBtn.disabled = true;
  confirmBtn.innerText = "PROCESSING...";

  /* 1Ô∏è‚É£ SALE */
  const saleRef = await addDoc(collection(db, "sales"), {
    shopId,
    soldBy: userId,
    role: "WORKER",
    customerName: custName.value.trim(),
    customerPhone: custPhone.value.trim(),
    items: cart.items,
    amount: total,
    createdAt: serverTimestamp()
  });

  /* 2Ô∏è‚É£ UPDATE STOCK */
  for (const i of cart.items) {
    await updateDoc(doc(db, "stock", i.productId), {
      quantity: i.stockQty - i.quantity
    });
  }

  /* 3Ô∏è‚É£ AUDIT LOG */
  await addDoc(collection(db, "auditLogs"), {
    userId,
    role: "WORKER",
    shopId,
    actionType: "SELL",
    action: `Sold items worth ‚Çπ${total}`,
    saleId: saleRef.id,
    timestamp: serverTimestamp()
  });

  localStorage.removeItem("cart");
  alert("Sale completed successfully");
  location.href = "sell.html";
};

/* CANCEL */
window.cancelCart = () => {
  localStorage.removeItem("cart");
  location.href = "sell.html";
};
</script>

</body>
</html>
