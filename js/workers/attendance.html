const workerId = localStorage.getItem("workerId");
const today = new Date().toISOString().split("T")[0];

const statusText = document.getElementById("todayStatus");
const todayDate = document.getElementById("todayDate");
const historyBox = document.getElementById("attendanceHistory");

todayDate.innerText = new Date().toDateString();

let attendance = JSON.parse(localStorage.getItem("attendance")) || [];

// Get today's record
let todayRecord = attendance.find(
    a => a.workerId === workerId && a.date === today
);

// Update status UI
function updateStatus() {
    if (!todayRecord) {
        statusText.innerText = "Not checked in";
        return;
    }

    if (todayRecord.checkIn && !todayRecord.checkOut) {
        statusText.innerText = `Checked in at ${todayRecord.checkIn}`;
    }

    if (todayRecord.checkOut) {
        statusText.innerText =
            `Checked out at ${todayRecord.checkOut}`;
    }
}

updateStatus();

// Check In
document.getElementById("checkInBtn").addEventListener("click", () => {
    if (todayRecord && todayRecord.checkIn) {
        alert("Already checked in");
        return;
    }

    todayRecord = {
        workerId,
        date: today,
        checkIn: new Date().toLocaleTimeString(),
        checkOut: null
    };

    attendance.push(todayRecord);
    localStorage.setItem("attendance", JSON.stringify(attendance));
    updateStatus();
});

// Check Out
document.getElementById("checkOutBtn").addEventListener("click", () => {
    if (!todayRecord || todayRecord.checkOut) {
        alert("Cannot check out now");
        return;
    }

    todayRecord.checkOut = new Date().toLocaleTimeString();
    localStorage.setItem("attendance", JSON.stringify(attendance));
    updateStatus();
});

// Show recent history (last 5)
const myHistory = attendance
    .filter(a => a.workerId === workerId)
    .slice(-5)
    .reverse();

if (myHistory.length === 0) {
    historyBox.innerHTML = "<p>No attendance history</p>";
} else {
    myHistory.forEach(a => {
        const row = document.createElement("div");
        row.className = "attendance-row";
        row.innerHTML = `
            <span>${a.date}</span>
            <span>${a.checkIn || "-"} â†’ ${a.checkOut || "-"}</span>
        `;
        historyBox.appendChild(row);
    });
}
